---
// src/pages/process/index.astro
import BaseLayout from "../../components/layout/BaseLayout.astro";
import ServiceHero from "../../components/sections/service/Hero/index.astro";
import Steps from "../../components/common/Steps/index.astro";
import DeliverablesList from "../../components/lists/DeliverablesList/index.astro";
import TimelineList from "../../components/timeline/TimelineList/index.astro";
import PostFeedLatest from "../../components/blog/compose/PostFeedLatest/index.astro";
import LeadCaptureBanner from "../../components/cta/LeadCaptureBanner/index.astro";
import TrustBar from "../../components/socialproof/TrustBar/index.astro";
import { getCollection } from "astro:content";
import processPage from "../../data/pages/process";

const { title, description, seo, hero, steps, deliverables, timeline, cta } = processPage;

const heroImage =
  typeof hero?.image === "string" && hero.image.trim().length > 0
    ? hero.image
    : "/assets/images/services/main-services-process-hero.webp";

const heroAlt =
  (typeof hero?.imageAlt === "string" && hero.imageAlt.trim().length > 0
    ? hero.imageAlt
    : typeof hero?.alt === "string" && hero.alt.trim().length > 0
    ? hero.alt
    : "Illustration of CV, cover letter and LinkedIn profile across screens") || "";

const PLACEHOLDER = "/assets/images/placeholder/blog-hero.webp";

const slugify = (s: string) =>
  String(s || "uncategorized")
    .toLowerCase()
    .trim()
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/(^-|-$)/g, "");

const isBad = (v: unknown) =>
  v === null ||
  v === undefined ||
  (typeof v === "string" && (!v.trim() || v.includes("undefined") || v.includes("null")));

const blogAll = await getCollection("blog", ({ data }) => !data.draft);

const blogPosts = blogAll
  .filter((p) => p?.data?.title && p?.data?.date && p?.slug)
  .map((p) => {
    const postSlug = p.slug.split("/").pop()!;
    const categorySlug = slugify(p.data.category ?? "uncategorized");

    let coverSrc: string | null = null;
    const cover = p.data.cover;
    const ogImage = p.data.ogImage;

    if (cover && typeof cover === "object" && typeof cover.src === "string") {
      coverSrc = cover.src;
    } else if (typeof cover === "string") {
      coverSrc = cover;
    } else if (typeof ogImage === "string") {
      coverSrc = ogImage;
    }

    if (isBad(coverSrc)) coverSrc = PLACEHOLDER;

    return {
      url: `/blog/${categorySlug}/${postSlug}/`,
      frontmatter: {
        title: p.data.title,
        description: p.data.description,
        date: new Date(p.data.date),
        readingTime:
          p.data.readingTimeMinutes ?? p.data.readingTime ?? undefined,
        category: p.data.category ?? "Uncategorized",
        cover: coverSrc ? { src: coverSrc, alt: p.data.title } : undefined,
      },
    };
  })
  .filter((p) => !isBad(p.frontmatter.cover?.src))
  .sort((a, b) => b.frontmatter.date.getTime() - a.frontmatter.date.getTime());

const PROCESS_CATEGORIES = ["cv-tips", "career-growth", "linkedin"] as const;

const getCategory = (cat: unknown): string => String(cat || "").toLowerCase().trim();

const relevantPosts = blogPosts.filter((post) =>
  PROCESS_CATEGORIES.includes(getCategory(post.frontmatter.category) as any)
);

const cvTipsPosts = relevantPosts.filter(
  (post) => getCategory(post.frontmatter.category) === "cv-tips"
);

let processLatestPosts = [];
if (cvTipsPosts.length > 0) {
  const featuredCvTips = cvTipsPosts[0];
  const remaining = relevantPosts.filter((p) => p !== featuredCvTips);
  processLatestPosts = [featuredCvTips, ...remaining].slice(0, 4);
} else {
  processLatestPosts = relevantPosts.slice(0, 4);
}

const showTrust = false;
---
<BaseLayout {title} {description} {seo}>
  <ServiceHero
    title={hero.title}
    sub={hero.sub}
    eyebrow={hero.eyebrow}
    actions={hero.actions}
    meta={hero.meta}
    image={heroImage}
    alt={heroAlt}
  />

  <section class="container mt-12" aria-label="Step-by-step CV writing process">
    <Steps
      title={steps.title ?? "How your CV project runs"}
      eyebrow={steps.eyebrow ?? "Step-by-step"}
      steps={steps.items}
      align="start"
      columns={4}
    />
  </section>

  {showTrust && (
    <section class="container mt-10" aria-label="Social proof">
      <TrustBar variant="compact" />
    </section>
  )}

  <section class="container mt-12" aria-label="What you receive and timeline">
    <div class="process-layout">
      <DeliverablesList
        eyebrow="Included in every package"
        title="What you receive"
        items={deliverables}
      />
      <TimelineList
        eyebrow="Fast and predictable"
        title="Typical timeline"
        items={timeline}
      />
    </div>
  </section>

  

  <section class="container mt-12" aria-label="Call to action">
    <LeadCaptureBanner
      title={cta.title}
      sub={cta.sub}
      primaryHref={cta.primaryHref}
      primaryLabel={cta.primaryLabel}
    />
  </section>

  <style>
    .process-layout {
      display: grid;
      grid-template-columns: 1fr;
      gap: var(--space-8);
    }
    @media (min-width: 768px) {
      .process-layout {
        grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
        align-items: flex-start;
      }
    }
  </style>
</BaseLayout>
