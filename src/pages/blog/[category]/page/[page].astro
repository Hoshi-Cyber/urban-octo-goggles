---
// File: src/pages/blog/[category]/page/[page].astro
/**
 * Paginated category view (pages ≥ 2)
 * IA: Breadcrumbs → Lean hero → Utility bar → Grid → LeadMagnet → Pagination → RelatedCategories
 * Static default with client-side sort/filter takeover (Fix Plan 156).
 *
 * FP-159: Keep CategoryUtilityBar inside the page container.
 * FP-160: Raise desktop stack gap between lean hero, toolbar, and list.
 * FP-163/164: Unify card markup and CSS with Blog home “Latest articles”.
 * FP-166: LeadMagnetStrip modern placement and CSS parity on paginated pages.
 * FP-169: Pagination sits inside the same stack right after LeadMagnetStrip.
 * FP-169.2: Add RelatedCategories after Pagination; no extra wrappers; up to 6 chips.
 * FP-187.5c: Consolidate canonical/og:url into BaseLayout only.
 */

import BaseLayout from "../../../../components/layout/BaseLayout.astro";
import Breadcrumbs from "../../../../components/blog/base/Breadcrumbs/index.astro";
import Pagination from "../../../../components/blog/compose/Pagination/index.astro";
import RelatedCategories from "../../../../components/blog/compose/RelatedCategories/index.astro";

// Toolbar island
import CategoryUtilityBar from "../../../../components/blog/compose/CategoryUtilityBar";
import "../../../../components/blog/compose/CategoryUtilityBar/styles.css";

// Feed CSS used on Blog home “Latest articles”
import feedCssUrl from "../../../../components/blog/compose/PostFeedLatest/PostFeedLatest.css?url";

// FP-166: Lead magnet component + CSS
import LeadMagnetStrip from "../../../../components/blog/compose/LeadMagnetStrip/index.astro";
import lmsCss from "../../../../components/blog/compose/LeadMagnetStrip/LeadMagnetStrip.css?url";

import { getCollection } from "astro:content";
import {
  CATEGORIES,
  PER_PAGE,
  paginate,
  categoryBasePath,
  categoryPagePath,
  prettyCategoryTitle,
  buildCategoryTitle,
  buildCategoryDescription,
  relatedCategories, // FP-169.2
} from "../../../../lib/blog/categories";

import { categorySlug, postUrlFromEntry, abs as absUrl } from "../../../../lib/slug";

export const prerender = true;

const PLACEHOLDER = "/images/blog/hero/blog-home-hero.webp";

const isBad = (v: unknown) =>
  v === null ||
  v === undefined ||
  (typeof v === "string" &&
    (!v.trim() || v.includes("undefined") || v.includes("null")));

/** Build static paths for pages ≥ 2 (page 1 lives at parent route) */
export async function getStaticPaths() {
  const entries = await Promise.all(
    CATEGORIES.map(async (c) => {
      const cSlug = categorySlug(c);
      const list = await getCollection(
        "blog",
        ({ data }) => !data.draft && categorySlug(data.category) === cSlug,
      );
      const count = Math.max(1, Math.ceil(list.length / PER_PAGE));
      return Array.from({ length: count }, (_, i) => ({
        params: { category: cSlug, page: String(i + 1) },
      }));
    }),
  );
  return entries.flat().filter((p) => p.params.page !== "1");
}

const { category, page } = Astro.params as { category: string; page: string };
const cat = categorySlug(category);

/** Derive best-available thumbnail with intrinsic size fallbacks */
function getThumb(p: any) {
  const data = p?.data ?? {};
  const cover = data.cover;
  const ogImage = data.ogImage;
  const thumbnail = data.thumbnail ?? data.image ?? cover ?? ogImage ?? null;

  let src: string | null = null;

  if (thumbnail && typeof thumbnail === "object" && typeof thumbnail.src === "string") {
    src = thumbnail.src;
  } else if (typeof thumbnail === "string") {
    src = thumbnail;
  }

  if (isBad(src)) {
    src = PLACEHOLDER;
  }

  const alt =
    (thumbnail && typeof thumbnail === "object" && thumbnail.alt?.trim()) ||
    data.title ||
    "Post thumbnail";

  const width =
    thumbnail && typeof thumbnail === "object" && typeof thumbnail.width === "number"
      ? thumbnail.width
      : 1200;
  const height =
    thumbnail && typeof thumbnail === "object" && typeof thumbnail.height === "number"
      ? thumbnail.height
      : 675;

  return { src, alt, width, height };
}

/** Fetch and sort posts */
const all = await getCollection(
  "blog",
  ({ data }) => !data.draft && categorySlug(data.category) === cat,
);

const posts = all
  .map((p) => {
    const { src: thumbnailSrc, alt: thumbnailAlt, width: thumbnailW, height: thumbnailH } = getThumb(p);
    const date = new Date(p.data.date);
    return {
      url: postUrlFromEntry(p),
      title: p.data.title,
      description: p.data.description,
      stage: p.data.stage ?? null,
      readMins: p.data.readingTimeMinutes ?? p.data.readingTime ?? null,
      date,
      dateISO: isNaN(date.getTime()) ? undefined : date.toISOString(),
      thumbnailSrc,
      thumbnailAlt,
      thumbnailW,
      thumbnailH,
      tags: Array.isArray(p.data.tags) ? p.data.tags : [],
    };
  })
  .sort((a, b) => b.date.getTime() - a.date.getTime());

/** Pagination */
const requested = Math.max(1, Number(page || "1"));
const { pageCount, page: current, start, slice: pageItems } = paginate(posts, requested, PER_PAGE);

/** URLs + SEO */
const basePath = categoryBasePath(cat);
const pretty = prettyCategoryTitle(cat);
let pageTitle = buildCategoryTitle(cat);
pageTitle = pageCount > 1 ? `${pageTitle} — Page ${current}` : pageTitle;
const desc = `${buildCategoryDescription(cat)} Page ${current} of ${pageCount}.`;

const selfUrl = categoryPagePath(cat, current);
const canonical = current === 1 ? `${basePath}/` : selfUrl;
const prevUrl = current > 2 ? categoryPagePath(cat, current - 1) : current === 2 ? `${basePath}/` : null;
const nextUrl = current < pageCount ? categoryPagePath(cat, current + 1) : null;

/** JSON-LD: Breadcrumbs (absolute URLs) */
const breadcrumbsLd = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  itemListElement: [
    { "@type": "ListItem", position: 1, name: "Home",  item: absUrl("/", Astro.site) },
    { "@type": "ListItem", position: 2, name: "Blog",  item: absUrl("/blog/", Astro.site) },
    { "@type": "ListItem", position: 3, name: pretty, item: absUrl(basePath + "/", Astro.site) },
    { "@type": "ListItem", position: 4, name: `Page ${current}`, item: absUrl(selfUrl, Astro.site) },
  ],
};

/** JSON-LD: ItemList */
const itemListLd = {
  "@context": "https://schema.org",
  "@type": "ItemList",
  itemListElement: pageItems.map((p, i) => ({
    "@type": "ListItem",
    position: start + i + 1,
    url: absUrl(p.url, Astro.site),
    name: p.title,
  })),
};

/** JSON-LD: CollectionPage */
const collectionPageLd = {
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  url: absUrl(canonical, Astro.site),
  name: `${pretty} — Page ${current}`,
  isPartOf: absUrl(basePath + "/", Astro.site),
};

/** Visible breadcrumbs */
const breadcrumbItems = [
  { label: "Home", href: "/" },
  { label: "Blog", href: "/blog/" },
  { label: pretty, href: `${basePath}/` },
  { label: `Page ${current}`, current: true },
];

/** First card image for OG + optional preload */
const ogImage = pageItems[0]?.thumbnailSrc ?? null;
---

<BaseLayout
  title={pageTitle}
  description={desc}
  seo={{ canonical, ogImage }}
  relPrev={prevUrl}
  relNext={nextUrl}
>
  <Fragment slot="head">
    {/* FP-187.5c: canonical and og:url are emitted by BaseLayout exclusively */}
    {ogImage && <meta property="og:image" content={ogImage} />}
    {ogImage && <link rel="preload" as="image" href={ogImage} />}

    <!-- Load the same CSS used by Blog home “Latest articles” -->
    <link rel="stylesheet" href={feedCssUrl} />
    <!-- FP-166: Ensure LeadMagnetStrip modern styles are present -->
    <link rel="stylesheet" href={lmsCss} />

    <!-- JSON-LD parity -->
    <script type="application/ld+json" is:inline>{JSON.stringify(breadcrumbsLd)}</script>
    <script type="application/ld+json" is:inline>{JSON.stringify(itemListLd)}</script>
    <script type="application/ld+json" is:inline>{JSON.stringify(collectionPageLd)}</script>
  </Fragment>

  <section class="container page-gap-after" data-section="category" aria-label="Category articles">
    <Breadcrumbs items={breadcrumbItems} />

    {/* Page-level stack governs spacing; desktop gap raised (FP-160) */}
    <div class="stack" style="--section-gap: clamp(var(--space-5), 2vw, var(--space-10));">
      {/* Lean hero for paginated views. No inner horizontal padding. */}
      <header data-section="hero" style="max-width:56rem;">
        <h1 class="h2" style="margin: 0 0 var(--space-2);">{pretty}</h1>
        <p class="text-muted" style="margin: 0 0 var(--space-3);">Page {current} of {pageCount}</p>
        <div class="flex items-center gap-3 flex-wrap">
          <a class="btn btn-primary" href="/services/cv-rewrite?utm_source=blog&utm_medium=category&utm_campaign=hero" data-cta="hero-primary" data-section="hero">Book CV Rewrite</a>
          <a class="btn" href="/offers/free-cv-audit?utm_source=blog&utm_medium=category&utm_campaign=hero" data-cta="hero-secondary" data-section="hero">Free 24-Point CV Audit</a>
        </div>
      </header>

      {/* Toolbar stays inside the container; spacing handled by the stack */}
      <section aria-label="Category controls">
        <CategoryUtilityBar client:load category={cat} pageSize={PER_PAGE} mountId="category-client-list" prettyCategory={pretty} />
      </section>

      {/* Inner stack: list → lead magnet → pagination → related (FP-169.2) */}
      <div class="stack" style="--section-gap: clamp(var(--space-8), 3vw, var(--space-12));">
        {/* Visible section header per Fix Plan 165 */}
        <section aria-labelledby="latest-heading">
          <header class="pfl__head">
            <p class="pfl__eyebrow">From the blog</p>
            <h2 id="latest-heading" class="pfl__title">Latest articles</h2>
          </header>

          {/* Client mount. Uses the exact pfl__grid contract for takeover parity */}
          <div class="pfl" aria-label="Client-rendered articles">
            <ol id="category-client-list" class="pfl__grid" role="list"></ol>
          </div>

          {/* SSR fallback grid for SEO and no-JS — no tags rendered */}
          {pageItems.length === 0 ? (
            <p class="text-muted">No posts yet. Check back soon.</p>
          ) : (
            <section class="ssr-grid" data-section="grid" aria-labelledby="ssr-articles-heading">
              <h3 id="ssr-articles-heading" class="sr-only">Articles</h3>
              <ol class="pfl__grid" role="list">
                {pageItems.slice(0, 8).map((p, i) => {
                  const eager = i < 4;
                  const high = i < 2;
                  const dateStr = new Date(p.date).toLocaleDateString();
                  const catName = pretty;
                  const excerpt = p.description ?? "";
                  return (
                    <li role="listitem">
                      <article class="pfl__card" aria-label={p.title}>
                        <a class="pfl__media" href={p.url}>
                          {p.thumbnailSrc && (
                            <img
                              src={p.thumbnailSrc}
                              alt={p.thumbnailAlt ?? p.title}
                              width={p.thumbnailW}
                              height={p.thumbnailH}
                              loading={eager ? "eager" : "lazy"}
                              decoding="async"
                              {...(high ? { fetchpriority: "high" } : {})}
                            />
                          )}
                        </a>
                        <div class="pfl__body">
                          <p class="pfl__cat"><a href={`${basePath}/`}>{catName}</a></p>
                          <h3 class="pfl__cardTitle">
                            <a href={p.url} class="pfl__link">{p.title}</a>
                          </h3>
                          {excerpt && <p class="pfl__excerpt clamp-3">{excerpt}</p>}
                          <p class="pfl__meta">
                            <time dateTime={p.dateISO}>{dateStr}</time> · {typeof p.readMins === "number" ? p.readMins : "—"} min read
                          </p>
                        </div>
                      </article>
                    </li>
                  );
                })}
              </ol>
            </section>
          )}
        </section>

        {/* FP-166: Lead magnet appears immediately after “Latest articles” */}
        <section id="leadmagnet" aria-label="Subscribe for the CV Optimization PDF">
          <LeadMagnetStrip
            title="Get the CV Optimization PDF"
            sub="Join 12,000+ professionals receiving actionable, local career tactics."
            action="/api/subscribe"
            source="blog_category_leadmagnet_paged"
          />
        </section>

        {/* FP-169: Pagination now inside the same stack, immediately after LeadMagnetStrip */}
        {pageCount > 1 && (
          <Pagination
            basePath={basePath}
            current={current}
            total={pageCount}
            query={Astro.url.search}   /* preserve ?sort & ?tag */
          />
        )}

        {/* FP-169.2: Related categories after Pagination; up to 6 chips; canonical URLs */}
        <RelatedCategories
          current={cat}
          items={relatedCategories(cat).slice(0, 6)}
          title="Related categories"
          variant="compact"
        />
      </div>
    </div>
  </section>
</BaseLayout>

<style>
  /* Hide SSR grid when the client list has content */
  #category-client-list:not(:empty) ~ .ssr-grid { display: none; }
</style>
