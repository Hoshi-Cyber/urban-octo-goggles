---
import BaseLayout from "../../../components/layout/BaseLayout.astro";
import PostFeedLatest from "../../../components/blog/compose/PostFeedLatest/index.astro";
import Pagination from "../../../components/blog/compose/Pagination/index.astro";
import { getCollection } from "astro:content";

/**
 * Blog pagination route:
 * - Handles /blog/page/2, /blog/page/3, ... as a dynamic server-rendered route.
 * - Page 1 is /blog/ (handled by src/pages/blog/index.astro).
 */

// This tells Astro: no getStaticPaths, treat this as a server-rendered dynamic route.
export const prerender = false;

const PER_PAGE = 8;
const PLACEHOLDER = "/assets/images/blog/hero/blog-home-hero.webp";

const slugify = (s: string) =>
  String(s || "uncategorized")
    .toLowerCase()
    .trim()
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/(^-|-$)/g, "");

// Heuristic validator to weed out obviously bad image values
const isBad = (v: unknown) =>
  v === null ||
  v === undefined ||
  (typeof v === "string" &&
    (!v.trim() || v.includes("undefined") || v.includes("null")));

// Load all non-draft posts
const all = await getCollection("blog", ({ data }) => !data.draft);

// Normalize to the shape used by PostFeedLatest
const posts = all
  .filter((p) => p?.data?.title && p?.data?.date && p?.slug)
  .map((entry) => {
    const data = entry.data as any;
    const postSlug = entry.slug.split("/").pop()!;
    const categorySlug = slugify(data.category ?? "uncategorized");

    // Prefer cover.src, then cover (string), then ogImage.src
    let coverSrc: string | null = null;
    const cover = data.cover;
    const ogImage = data.ogImage;

    if (cover && typeof cover === "object" && typeof cover.src === "string") {
      coverSrc = cover.src;
    } else if (typeof cover === "string") {
      coverSrc = cover;
    } else if (ogImage && typeof ogImage === "object" && typeof ogImage.src === "string") {
      coverSrc = ogImage.src;
    }

    if (isBad(coverSrc)) coverSrc = PLACEHOLDER;

    return {
      slug: postSlug,
      title: data.title,
      description: data.description,
      excerpt: data.description ?? data.metaDescription,
      href: `/blog/${categorySlug}/${postSlug}/`,
      date: new Date(data.date),
      author: data.author,
      tags: data.tags ?? [],
      cover: coverSrc,
      category: data.category ?? "Uncategorized",
      categorySlug,
      readingTime:
        data.readingTimeMinutes ??
        data.readingTime ??
        undefined,
    };
  })
  .filter((p) => !isBad(p.cover))
  .sort((a, b) => b.date.getTime() - a.date.getTime());

// Featured is the latest post; the rest are paginated
const featured = posts[0] ?? null;
const rest = featured ? posts.slice(1) : [];

// Page param: /blog/page/2, /blog/page/3, ...
const page = Number(Astro.params.page ?? 2);

// Basic guard
if (!Number.isFinite(page) || page < 2) {
  throw new Error(`Invalid blog page number: ${Astro.params.page}`);
}

const totalItems = rest.length;
const totalPages = Math.max(1, Math.ceil(totalItems / PER_PAGE));

if (page > totalPages) {
  throw new Error(`Blog page ${page} does not exist (only ${totalPages} pages).`);
}

// Slice items for this page
const start = (page - 1) * PER_PAGE;
const end = start + PER_PAGE;
const pageItems = rest.slice(start, end);

// Adapt shape for PostFeedLatest (original contract)
const feedPosts = pageItems.map((p) => ({
  slug: p.slug,
  title: p.title,
  category: p.category,
  categorySlug: p.categorySlug,
  date: p.date,
  href: p.href,
  readingTime: p.readingTime,
  excerpt: p.excerpt,
  thumbnail: p.cover ? { src: p.cover, alt: p.title } : undefined,
}));

// SEO links (respect trailingSlash: "always")
const canonical = `/blog/page/${page}/`;
const relPrev = page > 2 ? `/blog/page/${page - 1}/` : `/blog/`;
const relNext = page < totalPages ? `/blog/page/${page + 1}/` : null;

// Minimal JSON-LD (CollectionPage variation)
const jsonLd = {
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  url: canonical,
  name: `CV Writing Kenya — Blog (Page ${page})`,
};
---

<BaseLayout
  title={`Blog — Page ${page}`}
  description={`Articles page ${page}`}
  {canonical}
  {relPrev}
  {relNext}
>
  <script type="application/ld+json">
    {JSON.stringify(jsonLd)}
  </script>

  <section class="section container" aria-labelledby="blog-listing">
    <h1 id="blog-listing" class="sr-only">All articles</h1>

    <PostFeedLatest
      posts={feedPosts}
      pageSize={PER_PAGE}
      eyebrow={`Page ${page} of ${totalPages}`}
      title="Latest articles"
      moreHref="/blog/"
      moreLabel="Back to blog home"
      moreAriaLabel="Back to blog home"
      ctaClass="pfl__viewAll"
      clientLoadMore={false}
    />

    {totalPages > 1 && (
      <div style="margin-top: var(--space-8);">
        <Pagination basePath="/blog" current={page} total={totalPages} />
      </div>
    )}
  </section>
</BaseLayout>
