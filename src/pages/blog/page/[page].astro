---
import BaseLayout from "../../../components/layout/BaseLayout.astro";
import PostFeedLatest from "../../../components/blog/compose/PostFeedLatest/index.astro";
import Pagination from "../../../components/blog/compose/Pagination/index.astro";
import { getCollection } from "astro:content";

/**
 * Blog pagination route:
 * - Handles /blog/page/2, /blog/page/3, ... as a dynamic server-rendered route.
 * - Page 1 is /blog/ (handled by src/pages/blog/index.astro).
 */

// This tells Astro: no getStaticPaths, treat this as a server-rendered dynamic route.
export const prerender = false;

const PER_PAGE = 8;

// Load all non-draft posts
const all = await getCollection("blog", ({ data }) => !data.draft);

// Normalize to the shape used by PostFeedLatest
const posts = all
  .filter((p) => p?.data?.title && p?.data?.date && p?.slug)
  .map((entry) => {
    const data = entry.data as any;
    return {
      title: data.title,
      description: data.description,
      // Use the collection slug directly (e.g. "cv-tips/2025-cv-format-...")
      href: `/blog/${entry.slug}/`,
      date: new Date(data.date),
      author: data.author,
      tags: data.tags ?? [],
      cover:
        typeof data.cover === "string"
          ? data.cover
          : (data.cover?.src ?? data.ogImage ?? null),
      category: data.category,
      readingTime: data.readingTimeMinutes ?? data.readingTime ?? undefined,
    };
  })
  .sort((a, b) => b.date.getTime() - a.date.getTime());

// Featured is the latest post; the rest are paginated
const featured = posts[0] ?? null;
const rest = featured ? posts.slice(1) : [];

// Page param: /blog/page/2, /blog/page/3, ...
const page = Number(Astro.params.page ?? 2);

// Basic guard
if (!Number.isFinite(page) || page < 2) {
  throw new Error(`Invalid blog page number: ${Astro.params.page}`);
}

const totalItems = rest.length;
const totalPages = Math.max(1, Math.ceil(totalItems / PER_PAGE));

if (page > totalPages) {
  throw new Error(`Blog page ${page} does not exist (only ${totalPages} pages).`);
}

// Slice items for this page
const start = (page - 1) * PER_PAGE;
const end = start + PER_PAGE;
const pageItems = rest.slice(start, end);

// Adapt shape for PostFeedLatest (url + frontmatter)
const feedPosts = pageItems.map((p) => ({
  url: p.href,
  frontmatter: {
    title: p.title,
    description: p.description,
    date: p.date,
    readingTime: p.readingTime,
    category: p.category,
    cover: p.cover ? { src: p.cover, alt: p.title } : undefined,
  },
}));

// SEO links (respect trailingSlash: "always")
const canonical = `/blog/page/${page}/`;
const relPrev = page > 2 ? `/blog/page/${page - 1}/` : `/blog/`;
const relNext = page < totalPages ? `/blog/page/${page + 1}/` : null;

// Minimal JSON-LD (CollectionPage variation)
const jsonLd = {
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  url: canonical,
  name: `CV Writing Kenya — Blog (Page ${page})`,
};
---

<BaseLayout
  title={`Blog — Page ${page}`}
  description={`Articles page ${page}`}
  {canonical}
  {relPrev}
  {relNext}
>
  <script type="application/ld+json">
    {JSON.stringify(jsonLd)}
  </script>

  <section class="section container" aria-labelledby="blog-listing">
    <h1 id="blog-listing" class="sr-only">All articles</h1>

    <PostFeedLatest
      posts={feedPosts}
      pageSize={PER_PAGE}
      eyebrow={`Page ${page} of ${totalPages}`}
      title="Latest articles"
      moreHref="/blog/"
      moreLabel="Back to blog home"
      moreAriaLabel="Back to blog home"
      ctaClass="pfl__viewAll"
      clientLoadMore={false}
    />

    {totalPages > 1 && (
      <div style="margin-top: var(--space-8);">
        <Pagination basePath="/blog" current={page} total={totalPages} />
      </div>
    )}
  </section>
</BaseLayout>
