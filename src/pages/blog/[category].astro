---
// File: src/pages/blog/[category].astro
/**
 * Category landing (page 1)
 * Canonical paths:
 * - Category: /blog/<category>/
 * - Post:     /blog/<category>/<slug>/
 *
 * Step 4 — Performance Controls (Fix Plan 156.1):
 * - Explicit width/height on all <img>.
 * - loading="eager" for first-fold hero card image; others "lazy".
 * - <link rel="preload" as="image"> for first-fold image.
 * - No extra hydration beyond CategoryUtilityBar.
 *
 * Step 5 — Head Tags & JSON-LD Parity (Fix Plan 156.1):
 * - Page 1 mirrors paginated pages' head structure.
 * - Canonical + rel=next parity.
 * - Inline JSON-LD: BreadcrumbList, ItemList, CollectionPage with absolute URLs.
 */

import BaseLayout from "../../components/layout/BaseLayout.astro";
import Breadcrumbs from "../../components/blog/base/Breadcrumbs/index.astro";
import CategoryHero from "../../components/blog/compose/CategoryHero/index.astro";
import Pagination from "../../components/blog/compose/Pagination/index.astro";
import RelatedCategories from "../../components/blog/compose/RelatedCategories/index.astro";
import LeadMagnetStrip from "../../components/blog/compose/LeadMagnetStrip/index.astro";
// Replaced PostFeedLatest with SSR list the client island can control
// import PostFeedLatest from "../../components/blog/compose/PostFeedLatest/index.astro";

import CategoryUtilityBar from "../../components/blog/compose/CategoryUtilityBar";
import "../../components/blog/compose/CategoryUtilityBar/styles.css";

import { getCollection } from "astro:content";
import {
  PER_PAGE,
  relatedCategories,
  prettyCategoryTitle,
  buildCategoryTitle,
  buildCategoryDescription,
} from "../../lib/blog/categories";
import { categorySlug, postUrlFromEntry, abs as absUrl } from "../../lib/slug";

export const prerender = true;

/** Static paths from canonical category list */
export async function getStaticPaths() {
  const { CATEGORIES } = await import("../../lib/blog/categories");
  return CATEGORIES.map((c: string) => ({
    params: { category: categorySlug(c) },
  }));
}

/** Params */
const { category } = Astro.params as { category: string };
const cat = categorySlug(category);

/** Validate category */
const { CATEGORIES } = await import("../../lib/blog/categories");
const ALLOWED = new Set<string>(CATEGORIES.map((c: string) => categorySlug(c)));
if (!ALLOWED.has(cat)) {
  return Astro.redirect("/404");
}

/** Thumbnail resolver with intrinsic size defaults to avoid CLS */
function getThumb(p: any) {
  const t = p.data?.thumbnail ?? p.data?.image ?? p.data?.cover ?? p.data?.ogImage ?? null;
  const src = typeof t === "string" ? t : t?.src ?? "/assets/logos/logo-wide-1200.png";
  const alt = (typeof t === "object" && t?.alt) ? t.alt : p.data?.title ?? "Post thumbnail";
  const width = (typeof t === "object" && typeof t?.width === "number") ? t.width : 1200;
  const height = (typeof t === "object" && typeof t?.height === "number") ? t.height : 675;
  return { src, alt, width, height };
}

/** Fetch, map, sort */
let all: any[] = [];
try {
  all = await getCollection("blog", ({ data }) => !data.draft && categorySlug(data.category) === cat);
} catch {
  all = [];
}

const posts = all
  .map((p) => {
    const { src: thumbnailSrc, alt: thumbnailAlt, width: thumbnailW, height: thumbnailH } = getThumb(p);
    const date = new Date(p.data.date);
    return {
      url: postUrlFromEntry(p), // single source of truth
      title: p.data.title,
      description: p.data.description,
      stage: p.data.stage ?? null,
      readMins: p.data.readingTimeMinutes ?? p.data.readingTime ?? null,
      date,
      dateISO: isNaN(date.getTime()) ? undefined : date.toISOString(),
      thumbnailSrc,
      thumbnailAlt,
      thumbnailW,
      thumbnailH,
      tags: Array.isArray(p.data.tags) ? p.data.tags : [],
    };
  })
  .sort((a, b) => b.date.getTime() - a.date.getTime());

/** Pagination (page 1) */
const pageCount = Math.max(1, Math.ceil(posts.length / PER_PAGE));
const pageItems = posts.slice(0, PER_PAGE);

/** URLs + SEO */
const basePath = `/blog/${cat}`;
const pretty = prettyCategoryTitle(cat);
const pageTitle = buildCategoryTitle(cat);
const desc = buildCategoryDescription(cat);
const canonical = `${basePath}/`;
const nextUrl = pageCount > 1 ? `${basePath}/page/2/` : null;

/** Hero stats */
const postCount = posts.length;
const lastUpdated = posts[0]?.date ?? null;
const readRange = "4–9 min";

/** First card image for OG + preload */
const ogImage = pageItems[0]?.thumbnailSrc ?? null;

/** JSON-LD (parity with paginated pages, use absolute URLs) */
const current = 1;
const breadcrumbsLd = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  itemListElement: [
    { "@type": "ListItem", position: 1, name: "Home",  item: absUrl("/", Astro.site) },
    { "@type": "ListItem", position: 2, name: "Blog",  item: absUrl("/blog/", Astro.site) },
    { "@type": "ListItem", position: 3, name: pretty, item: absUrl(`${basePath}/`, Astro.site) },
    { "@type": "ListItem", position: 4, name: `Page ${current}`, item: absUrl(canonical, Astro.site) },
  ],
};

const itemListLd = {
  "@context": "https://schema.org",
  "@type": "ItemList",
  itemListElement: pageItems.map((p, i) => ({
    "@type": "ListItem",
    position: i + 1,
    url: absUrl(p.url, Astro.site),
    name: p.title,
  })),
};

const collectionPageLd = {
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  url: absUrl(canonical, Astro.site),
  name: `${pretty} — Page ${current}`,
  isPartOf: absUrl(`${basePath}/`, Astro.site),
};

/** Breadcrumbs (visible) */
const breadcrumbItems = [
  { label: "Home", href: "/" },
  { label: "Blog", href: "/blog/" },
  { label: pretty, current: true },
];
---

<BaseLayout title={pageTitle} description={desc} seo={{ canonical }}>
  <fragment slot="head">
    <link rel="canonical" href={canonical} />
    {nextUrl && <link rel="next" href={nextUrl} />}
    <meta property="og:title" content={pageTitle} />
    <meta property="og:url" content={canonical} />
    {ogImage && <meta property="og:image" content={ogImage} />}
    {/* Performance: Preload first-fold image to improve LCP */}
    {ogImage && <link rel="preload" as="image" href={ogImage} />}

    <!-- JSON-LD parity with paginated pages -->
    <script type="application/ld+json" is:inline>{JSON.stringify(breadcrumbsLd)}</script>
    <script type="application/ld+json" is:inline>{JSON.stringify(itemListLd)}</script>
    <script type="application/ld+json" is:inline>{JSON.stringify(collectionPageLd)}</script>
  </fragment>

  <section class="container page-gap-after" data-section="category" aria-label="Category articles">
    <Breadcrumbs items={breadcrumbItems} />

    <div class="stack" style="--section-gap: clamp(var(--space-3), 1.5vw, var(--space-5));">
      <CategoryHero
        title={pretty}
        dek={desc}
        stats={{ postCount, lastUpdated: lastUpdated ?? undefined, readRange }}
        primaryCta={{ href: "/services/cv-rewrite?utm_source=blog&utm_medium=category&utm_campaign=hero", label: "Book CV Rewrite" }}
        secondaryCta={{ href: "/offers/free-cv-audit?utm_source=blog&utm_medium=category&utm_campaign=hero", label: "Free 24-Point CV Audit" }}
      />

      {/* Utility bar island: client-side sort/filter + pagination (only hydration on page) */}
      <CategoryUtilityBar client:load category={cat} pageSize={PER_PAGE} mountId="category-client-list" />

      <div class="stack" style="--section-gap: clamp(var(--space-8), 3.5vw, var(--space-12));">
        {/* Server-rendered default list for SEO and no-JS. Labeled for a11y. */}
        <section aria-labelledby="latest-heading">
          <h2 id="latest-heading" class="sr-only">Latest articles</h2>
          <ol
            id="category-client-list"
            class="post-grid"
            role="list"
            style="list-style:none; padding:0; margin:0; display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:1rem;"
          >
            {pageItems.map((p, i) => {
              const headingId = `post-card-h${i}`;
              const isFirstCard = i === 0;
              return (
                <li role="listitem" class="c-card">
                  <article aria-labelledby={headingId}>
                    <a class="c-card__media" href={p.url}>
                      {p.thumbnailSrc && (
                        <img
                          src={p.thumbnailSrc}
                          alt={p.thumbnailAlt ?? p.title}
                          width={p.thumbnailW}
                          height={p.thumbnailH}
                          loading={isFirstCard ? "eager" : "lazy"}  /* Step 4: eager for first-fold, lazy for below-fold */
                        />
                      )}
                    </a>
                    <div class="c-card__body">
                      <h3 id={headingId} class="c-card__title"><a href={p.url}>{p.title}</a></h3>
                      <p class="c-card__meta">
                        {new Date(p.date).toLocaleDateString()} · {typeof p.readMins === "number" ? p.readMins : "—"} min read
                      </p>
                      {p.tags?.length > 0 && (
                        <ul class="c-card__tags" role="list" style="display:flex;gap:.4rem;flex-wrap:wrap;padding:0;margin:0;list-style:none;">
                          {p.tags.map((t) => <li role="listitem" class="tag-chip">{t}</li>)}
                        </ul>
                      )}
                    </div>
                  </article>
                </li>
              );
            })}
          </ol>
        </section>

        <LeadMagnetStrip
          title="Get the CV Optimization PDF"
          sub="Join 12,000+ professionals receiving actionable, local career tactics."
          action="/api/subscribe"
          source="blog_category_leadmagnet"
        />

        {pageCount > 1 && (
          <Pagination
            basePath={basePath}
            current={1}
            total={pageCount}
            query={Astro.url.search}  /* preserve ?sort & ?tag */
          />
        )}

        <RelatedCategories
          items={relatedCategories(cat).slice(0, 3)}
          current={cat}
          title="Related categories"
          variant="compact"
        />
      </div>
    </div>
  </section>
</BaseLayout>

<style>
  /* Hide SSR grid when the client list has content (client island takeover) */
  #category-client-list:empty ~ .ssr-grid { display: block; }
  #category-client-list:not(:empty) ~ .ssr-grid { display: none; }

  .tag-chip { font-size: 0.75rem; padding: 0.2rem 0.45rem; border: 1px solid var(--border, #ddd); border-radius: 999px; }
</style>
