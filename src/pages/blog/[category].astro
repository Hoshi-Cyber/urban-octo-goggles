---
// File: src/pages/blog/[category].astro
/**
 * Category landing (page 1)
 * Canonical:
 * - Category: /blog/<category>/
 * - Post:     /blog/<category>/<slug>/
 *
 * FP-156.1  Performance + Head/JSON-LD parity
 * FP-158    Hero spacing & layout
 * FP-159    Keep toolbar inside page container
 * FP-160    Larger desktop gaps between Hero ↔ Toolbar ↔ Grid
 * FP-163    Unify cards with Blog Home “Latest articles” (use pfl__* contract)
 * FP-166    LeadMagnetStrip modern placement, spacing, and CSS parity
 * FP-167    Fix subscribe endpoint trailing-slash and action normalization
 * FP-168    Keep inline success/error UX; optional success page via successHref (not used here)
 * FP-169.2  Order parity: Grid → LeadMagnetStrip → Pagination → RelatedCategories; show up to 6 chips
 */

import BaseLayout from "../../components/layout/BaseLayout.astro";
import Breadcrumbs from "../../components/blog/base/Breadcrumbs/index.astro";
import CategoryHero from "../../components/blog/compose/CategoryHero/index.astro";
import Pagination from "../../components/blog/compose/Pagination/index.astro";
import RelatedCategories from "../../components/blog/compose/RelatedCategories/index.astro";
import LeadMagnetStrip from "../../components/blog/compose/LeadMagnetStrip/index.astro";

import CategoryUtilityBar from "../../components/blog/compose/CategoryUtilityBar";
import "../../components/blog/compose/CategoryUtilityBar/styles.css";

/* FP-163: load exact feed CSS used by Blog Home “Latest articles” */
import pflCss from "../../components/blog/compose/PostFeedLatest/PostFeedLatest.css?url";

/* FP-166: ensure LeadMagnetStrip modern styling is present on this page */
import lmsCss from "../../components/blog/compose/LeadMagnetStrip/LeadMagnetStrip.css?url";

import { getCollection } from "astro:content";
import {
  PER_PAGE,
  relatedCategories,
  prettyCategoryTitle,
  buildCategoryTitle,
  buildCategoryDescription,
} from "../../lib/blog/categories";
import { categorySlug, postUrlFromEntry, abs as absUrl } from "../../lib/slug";

export const prerender = true;

/** Static paths from canonical category list */
export async function getStaticPaths() {
  const { CATEGORIES } = await import("../../lib/blog/categories");
  return CATEGORIES.map((c: string) => ({
    params: { category: categorySlug(c) },
  }));
}

/** Params */
const { category } = Astro.params as { category: string };
const cat = categorySlug(category);

/** Validate category */
const { CATEGORIES } = await import("../../lib/blog/categories");
const ALLOWED = new Set<string>(CATEGORIES.map((c: string) => categorySlug(c)));
if (!ALLOWED.has(cat)) {
  return Astro.redirect("/404");
}

/** Thumbnail resolver with intrinsic size defaults to avoid CLS */
function getThumb(p: any) {
  const t = p.data?.thumbnail ?? p.data?.image ?? p.data?.cover ?? p.data?.ogImage ?? null;
  const src = typeof t === "string" ? t : t?.src ?? "/assets/logos/logo-wide-1200.png";
  const alt = (typeof t === "object" && t?.alt) ? t.alt : p.data?.title ?? "Post thumbnail";
  const width = (typeof t === "object" && typeof t?.width === "number") ? t.width : 1200;
  const height = (typeof t === "object" && typeof t?.height === "number") ? t.height : 675;
  return { src, alt, width, height };
}

/** Fetch, map, sort */
let all: any[] = [];
try {
  all = await getCollection("blog", ({ data }) => !data.draft && categorySlug(data.category) === cat);
} catch {
  all = [];
}

const posts = all
  .map((p) => {
    const { src: thumbnailSrc, alt: thumbnailAlt, width: thumbnailW, height: thumbnailH } = getThumb(p);
    const date = new Date(p.data.date);
    return {
      url: postUrlFromEntry(p),
      title: p.data.title,
      description: p.data.description,
      stage: p.data.stage ?? null,
      readMins: p.data.readingTimeMinutes ?? p.data.readingTime ?? null,
      date,
      dateISO: isNaN(date.getTime()) ? undefined : date.toISOString(),
      thumbnailSrc,
      thumbnailAlt,
      thumbnailW,
      thumbnailH,
      tags: Array.isArray(p.data.tags) ? p.data.tags : [],
    };
  })
  .sort((a, b) => b.date.getTime() - a.date.getTime());

/** Pagination (page 1) */
const pageCount = Math.max(1, Math.ceil(posts.length / PER_PAGE));
const pageItems = posts.slice(0, PER_PAGE);

/** URLs + SEO */
const basePath = `/blog/${cat}`;
const pretty = prettyCategoryTitle(cat);
const pageTitle = buildCategoryTitle(cat);
const desc = buildCategoryDescription(cat);
const canonical = `${basePath}/`;
const nextUrl = pageCount > 1 ? `${basePath}/page/2/` : null;

/** Hero stats */
const postCount = posts.length;
const lastUpdated = posts[0]?.date ?? null;
const readRange = "4–9 min";

/** First card image for OG + preload */
const ogImage = pageItems[0]?.thumbnailSrc ?? null;

/** JSON-LD */
const current = 1;
const breadcrumbsLd = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  itemListElement: [
    { "@type": "ListItem", position: 1, name: "Home",  item: absUrl("/", Astro.site) },
    { "@type": "ListItem", position: 2, name: "Blog",  item: absUrl("/blog/", Astro.site) },
    { "@type": "ListItem", position: 3, name: pretty, item: absUrl(`${basePath}/`, Astro.site) },
    { "@type": "ListItem", position: 4, name: `Page ${current}`, item: absUrl(canonical, Astro.site) },
  ],
};

const itemListLd = {
  "@context": "https://schema.org",
  "@type": "ItemList",
  itemListElement: pageItems.map((p, i) => ({
    "@type": "ListItem",
    position: i + 1,
    url: absUrl(p.url, Astro.site),
    name: p.title,
  })),
};

const collectionPageLd = {
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  url: absUrl(canonical, Astro.site),
  name: `${pretty} — Page ${current}`,
  isPartOf: absUrl(`${basePath}/`, Astro.site),
};

/** Breadcrumbs (visible) */
const breadcrumbItems = [
  { label: "Home", href: "/" },
  { label: "Blog", href: "/blog/" },
  { label: pretty, current: true },
];
---

<BaseLayout title={pageTitle} description={desc} seo={{ canonical, ogImage }} relNext={nextUrl}>
  <Fragment slot="head">
    {ogImage && <meta property="og:image" content={ogImage} />}
    {ogImage && <link rel="preload" as="image" href={ogImage} />}

    <link rel="stylesheet" href={pflCss} />
    <link rel="stylesheet" href={lmsCss} />

    <script type="application/ld+json" is:inline>{JSON.stringify(breadcrumbsLd)}</script>
    <script type="application/ld+json" is:inline>{JSON.stringify(itemListLd)}</script>
    <script type="application/ld+json" is:inline>{JSON.stringify(collectionPageLd)}</script>
  </Fragment>

  <section class="container page-gap-after" data-section="category" aria-label="Category articles">
    <Breadcrumbs items={breadcrumbItems} />

    <div class="stack" style="--section-gap: clamp(var(--space-5), 2vw, var(--space-10));">
      <CategoryHero
        title={pretty}
        dek={desc}
        stats={{ postCount, lastUpdated: lastUpdated ?? undefined, readRange }}
        primaryCta={{ href: "/services/cv-rewrite?utm_source=blog&utm_medium=category&utm_campaign=hero", label: "Book CV Rewrite" }}
        secondaryCta={{ href: "/offers/free-cv-audit?utm_source=blog&utm_medium=category&utm_campaign=hero", label: "Free 24-Point CV Audit" }}
      />

      <section aria-label="Category controls">
        <CategoryUtilityBar client:load category={cat} pageSize={PER_PAGE} mountId="category-client-list" prettyCategory={pretty} />
      </section>

      {/* Inner stack: Grid → LeadMagnet → Pagination → RelatedCategories (FP-169.2) */}
      <div class="stack" style="--section-gap: clamp(var(--space-8), 3vw, var(--space-12));">
        <section aria-labelledby="latest-heading">
          <header class="pfl__head">
            <p class="pfl__eyebrow">From the blog</p>
            <h2 id="latest-heading" class="pfl__title">Latest articles</h2>
          </header>

          <ol id="category-client-list" class="pfl__grid" role="list">
            {pageItems.map((p, i) => {
              const eager = i < 4;
              const high = i < 2;
              const dateStr = new Date(p.date).toLocaleDateString();
              return (
                <li role="listitem" class="pfl__card">
                  <article>
                    <a class="pfl__media" href={p.url}>
                      {p.thumbnailSrc && (
                        <img
                          src={p.thumbnailSrc}
                          alt={p.thumbnailAlt ?? p.title}
                          width={p.thumbnailW}
                          height={p.thumbnailH}
                          loading={eager ? "eager" : "lazy"}
                          decoding="async"
                          {...(high ? { fetchpriority: "high" } : {})}
                        />
                      )}
                    </a>
                    <div class="pfl__body">
                      <p class="pfl__cat"><a href={`${basePath}/`}>{pretty}</a></p>
                      <h3 class="pfl__cardTitle"><a href={p.url} class="pfl__link">{p.title}</a></h3>
                      {p.description && <p class="pfl__excerpt clamp-3">{p.description}</p>}
                      <p class="pfl__meta">
                        <time dateTime={p.dateISO}>{dateStr}</time> · {typeof p.readMins === "number" ? p.readMins : "—"} min read
                      </p>
                    </div>
                  </article>
                </li>
              );
            })}
          </ol>
        </section>

        {/* Lead magnet immediately after grid */}
        <section id="leadmagnet" aria-label="Subscribe for the CV Optimization PDF">
          <LeadMagnetStrip
            title="Get the CV Optimization PDF"
            sub="Join 12,000+ professionals receiving actionable, local career tactics."
            action="/api/subscribe/"
            source="blog_category_leadmagnet"
            /* To use a dedicated success page for campaigns, pass:
               successHref="/subscribe/success/" */
          />
        </section>

        {/* Pagination for page 1 when multiple pages exist */}
        {pageCount > 1 && (
          <Pagination
            basePath={basePath}
            current={1}
            total={pageCount}
            query={Astro.url.search}
          />
        )}

        {/* FP-169.2: Related categories after Pagination; up to 6 chips; canonical URLs */}
        <RelatedCategories
          items={relatedCategories(cat).slice(0, 6)}
          current={cat}
          title="Related categories"
          variant="compact"
        />
      </div>
    </div>
  </section>
</BaseLayout>

<style>
  .category-hero { padding-inline: 0 !important; padding-block: clamp(var(--space-8), 3vw, var(--space-12)); }
  .category-hero__grid { display: block; }
  @media (min-width: 1024px) {
    .category-hero__grid {
      display: grid !important;
      grid-template-columns: minmax(0,1.25fr) minmax(0,1fr);
      gap: clamp(var(--space-6), 3vw, var(--space-10));
    }
  }
  .category-hero__ctas { display: grid; grid-auto-flow: row; gap: var(--space-3); }
  @media (min-width: 640px) { .category-hero__ctas { grid-auto-flow: column; justify-content: start; } }
</style>
