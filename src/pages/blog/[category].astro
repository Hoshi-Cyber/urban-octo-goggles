---
import BaseLayout from "../../components/layout/BaseLayout.astro";
import "../../styles/pages/blog-category.css";
import { getCollection } from "astro:content";
import {
  getCategory,
  type CategorySlug,
  type BlogCategory,
} from "@/lib/blog/categories";

/**
 * Dynamic category route – no getStaticPaths.
 * This avoids any build-time errors and resolves entirely at request time.
 */
export const prerender = false;

// Local slug normaliser (no external dependencies)
function categorySlug(value: unknown): string {
  return String(value || "uncategorized")
    .toLowerCase()
    .trim()
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/(^-|-$)/g, "");
}

const { category } = Astro.params;
const rawCategory = category || "uncategorized";
const normalizedSlug = categorySlug(rawCategory);

// Resolve canonical category metadata from the central model
const categoryMeta = getCategory(normalizedSlug) as BlogCategory | undefined;

// If the slug does not map to a known category, go to 404
if (!categoryMeta) {
  return Astro.redirect("/404/");
}

// Canonical category slug (one of the 5 defined CategorySlug values)
const cat = categoryMeta.slug as CategorySlug;

// Load all non-draft posts
const allEntries = await getCollection("blog", ({ data }) => !data.draft);

// Filter posts for this category using the canonical slug
const categoryEntries = allEntries.filter((entry) => {
  const name = (entry.data as any)?.category ?? "";
  const entrySlug = categorySlug(name);
  return entrySlug === cat;
});

// FP005-07: Special-case empty category behaviour for "hiring-insights".
// - For existing categories: keep 404 on empty.
// - For "hiring-insights": allow 0 posts and render an empty listing.
if (!categoryEntries.length && cat !== "hiring-insights") {
  return Astro.redirect("/404/");
}

// Hero images per category (fallback to default)
const HERO_IMAGES: Record<CategorySlug, string> = {
  "cv-strategy": "/assets/images/blog/hero/blog-home-hero-01.webp",
  linkedin: "/assets/images/blog/hero/blog-home-hero-02.webp",
  "career-growth": "/assets/images/blog/hero/blog-home-hero-03.webp",
  "kenya-market": "/assets/images/blog/hero/blog-home-hero-04.webp",
  "hiring-insights": "/assets/images/blog/hero/blog-home-hero-03.webp",
};

// Separate OG images mapping so hero image and OG image can diverge if needed
const OG_IMAGES: Record<CategorySlug, string> = {
  "cv-strategy":
    "/assets/images/blog/og/categories/blog-category-cv-strategy-og.webp",
  linkedin:
    "/assets/images/blog/og/categories/blog-category-linkedin-og.webp",
  "career-growth":
    "/assets/images/blog/og/categories/blog-category-career-growth-og.webp",
  "kenya-market":
    "/assets/images/blog/og/categories/blog-category-kenya-market-og.webp",
  "hiring-insights":
    "/assets/images/blog/og/categories/blog-category-hiring-insights-og.webp",
};

const defaultHeroImage = "/assets/images/blog/hero/blog-home-hero.webp";

const heroImageSrc = HERO_IMAGES[cat] ?? defaultHeroImage;
const ogImageSrc = OG_IMAGES[cat] ?? heroImageSrc;

// Map entries into the unified post shape for the feed
const posts = categoryEntries
  .map((entry) => {
    const data: any = entry.data;
    const categoryName: string = data.category ?? "Uncategorized";
    const catSlug = categorySlug(categoryName);

    const baseSlug =
      typeof entry.slug === "string" && entry.slug.includes("/")
        ? entry.slug.split("/").pop()!
        : (entry.slug as string);

    const url = `/blog/${catSlug}/${baseSlug}/`;

    const frontmatter = {
      title: data.title ?? "Untitled article",
      description: data.description ?? data.metaDescription ?? "",
      date: data.date ?? "",
      readingTime: data.readingTime,
      category: categoryName,
      cover: data.cover
        ? {
            src: data.cover.src,
            alt: data.cover.alt || data.title,
            width: data.cover.width,
            height: data.cover.height,
          }
        : undefined,
    };

    return { url, frontmatter };
  })
  // Newest → oldest, so cards are always ordered by date
  .sort((a, b) => {
    const at = new Date(a.frontmatter.date as any).getTime() || 0;
    const bt = new Date(b.frontmatter.date as any).getTime() || 0;
    return bt - at;
  });

const totalPosts = posts.length;

// Page size for category landing – show first 12 posts
const PAGE_SIZE = 12;
const postsPage1 = posts.slice(0, PAGE_SIZE);
const hasMore = posts.length > PAGE_SIZE;

// Helpers
const fmtDate = (d: string | Date) =>
  new Date(d).toLocaleDateString("en-KE", {
    year: "numeric",
    month: "short",
    day: "numeric",
  });

const catHref = (p: { frontmatter: any }) =>
  `/blog/${categorySlug(p.frontmatter?.category || "uncategorized")}/`;

// Hero copy (from canonical category metadata)
const heroTitle = categoryMeta.heroTitle || categoryMeta.name;
const heroSubtitle = categoryMeta.heroSubtitle || categoryMeta.description;

// SEO copy derived from canonical metadata
const seoTitleText = categoryMeta.name || "Blog category";
const seoDescriptionText =
  categoryMeta.description ||
  "Curated articles from CVWriting.co.ke on CVs, interviews, and strategy.";

const pageTitle = `${seoTitleText} | CVWriting.co.ke Blog`;
const pageDescription = seoDescriptionText;

const seo = {
  title: pageTitle,
  description: pageDescription,
  openGraph: {
    title: pageTitle,
    description: pageDescription,
    image: ogImageSrc,
  },
};
---

<BaseLayout title={pageTitle} description={pageDescription} {seo}>
  <main data-section="blog-category">
    <!-- HERO: page title, description, hero image (mobile-first, 2-column on desktop) -->
    <section class="section bcat-hero" aria-labelledby="bcat-hero-heading">
      <div class="container bcat-hero__inner">
        <div class="bcat-hero__copy">
          <p class="bcat-hero__eyebrow">Blog category</p>
          <!-- h1 element using global h1 styling -->
          <h1 id="bcat-hero-heading" class="bcat-hero__title section-title h1">
            {heroTitle}
          </h1>
          <p class="bcat-hero__lede">
            {heroSubtitle}
          </p>
          <p class="bcat-hero__meta">
            <span class="bcat-hero__metaPill">
              {totalPosts} Post{totalPosts === 1 ? "" : "s"}
            </span>
          </p>
        </div>

        <figure class="bcat-hero__media">
          <img
            src={heroImageSrc}
            alt={`${heroTitle} hero image`}
            loading="eager"
            decoding="async"
            width="1200"
            height="720"
            sizes="(min-width: 1024px) 38vw, 100vw"
          />
        </figure>
      </div>
    </section>

    <!-- FEED: Latest articles -->
    <section
      class="section bcat-feed"
      aria-label="Latest articles in this category"
    >
      <div class="container">
        <div class="bcat-feed__container">
          <header class="bcat-feed__head">
            <p class="bcat-feed__eyebrow">From the blog</p>
            <h2 class="bcat-feed__title section-title h2">Latest articles</h2>
          </header>

          <div id="bcat-grid" class="bcat-grid">
            {postsPage1.length === 0 ? (
              <p class="bcat-feed__empty">
                No articles in this category yet. New insights are coming soon.
              </p>
            ) : (
              postsPage1.map((p, idx) => {
                const href = p.url;
                const categoryLink = catHref(p);
                const dt = new Date(p.frontmatter.date);
                const dateIso = isNaN(dt.getTime())
                  ? undefined
                  : dt.toISOString();

                return (
                  <article
                    class="bcat-card"
                    data-index={idx}
                    data-cat={
                      (p.frontmatter?.category ?? "").trim() ||
                      "uncategorized"
                    }
                  >
                    {p.frontmatter?.cover?.src ? (
                      <a
                        href={href}
                        class="bcat-card__media"
                        aria-label={`Read ${p.frontmatter.title}`}
                      >
                        <img
                          src={p.frontmatter.cover.src}
                          alt={
                            p.frontmatter.cover.alt ?? p.frontmatter.title
                          }
                          width={p.frontmatter.cover.width ?? 640}
                          height={p.frontmatter.cover.height ?? 360}
                          loading={idx < 4 ? "eager" : "lazy"}
                          decoding="async"
                          sizes="(min-width:1280px) 25vw, (min-width:1024px) 25vw, (min-width:640px) 33vw, 100vw"
                          fetchpriority={idx < 2 ? "high" : "low"}
                        />
                      </a>
                    ) : (
                      <div
                        class="bcat-card__media bcat-card__media--empty"
                        aria-hidden="true"
                      />
                    )}

                    <div class="bcat-card__body">
                      {p.frontmatter?.category && (
                        <p class="bcat-card__cat">
                          <a
                            href={categoryLink}
                            aria-label={`View ${p.frontmatter.category} posts`}
                          >
                            {p.frontmatter.category}
                          </a>
                        </p>
                      )}

                      <h3 class="bcat-card__title line-clamp-2">
                        <a
                          href={href}
                          class="bcat-card__link"
                          aria-label={`Read ${p.frontmatter.title}`}
                        >
                          {p.frontmatter.title}
                        </a>
                      </h3>

                      {p.frontmatter?.description && (
                        <p class="bcat-card__excerpt clamp-3">
                          {p.frontmatter.description}
                        </p>
                      )}

                      <p class="bcat-card__meta">
                        {dateIso && (
                          <span class="bcat-card__metaPill bcat-card__metaPill--date">
                            <time datetime={dateIso}>
                              {fmtDate(p.frontmatter.date)}
                            </time>
                          </span>
                        )}
                        {typeof p.frontmatter?.readingTime === "number" && (
                          <span
                            class="bcat-card__metaPill bcat-card__metaPill--read"
                            aria-label={`${p.frontmatter.readingTime} minute read`}
                          >
                            {p.frontmatter.readingTime} min read
                          </span>
                        )}
                      </p>
                    </div>
                  </article>
                );
              })
            )}
          </div>

          {hasMore && postsPage1.length > 0 && (
            <div class="bcat-feed__actions">
              <a
                href={`/blog/${cat}/page/2/`}
                aria-label="View more posts in this category"
                class="bcat-feed__more"
                data-cta="category-view-more"
              >
                View more
              </a>
            </div>
          )}
        </div>
      </div>
    </section>
  </main>
</BaseLayout>
