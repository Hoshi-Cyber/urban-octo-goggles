---
// src/components/faq/FAQAccordion/index.astro

import "./FAQAccordion.css";

/**
 * FAQAccordion — mobile-first, token-driven, a11y-first
 * Props:
 *  items: Array<{ q: string; a: string }>
 *  title?: string
 *  sub?: string
 *  class?: string
 *  schema?: boolean
 *  showHead?: boolean
 */

export interface QA {
  q: string;
  a: string;
}

export interface Props {
  items: QA[];
  title?: string;
  sub?: string;
  class?: string;
  schema?: boolean;
  showHead?: boolean;
}

const {
  items = [],
  title = "Frequently asked questions",
  sub,
  class: className = "",
  schema = true,
  showHead = true,
} = Astro.props as Props;

// Unique id per instance for safe event scoping
const listId = `faq-${Math.random().toString(36).slice(2, 8)}`;

// Derive schema-safe items (strip simple tags, drop empty Q/A)
const schemaEntities =
  schema && Array.isArray(items)
    ? items
        .filter(
          (it) =>
            typeof it.q === "string" &&
            it.q.trim().length > 0 &&
            typeof it.a === "string" &&
            it.a.trim().length > 0,
        )
        .map((it) => {
          const plain = it.a
            .replace(/<[^>]+>/g, " ")
            .replace(/\s+/g, " ")
            .trim();

          return {
            "@type": "Question",
            name: it.q.trim(),
            acceptedAnswer: {
              "@type": "Answer",
              text: plain,
            },
          };
        })
    : [];

const faqSchema =
  schema && schemaEntities.length > 0
    ? {
        "@context": "https://schema.org",
        "@type": "FAQPage",
        mainEntity: schemaEntities,
      }
    : null;
---

<section
  class={`section ${className}`.trim()}
  data-section="faq"
  aria-labelledby={showHead ? `${listId}-title` : undefined}
>
  <div class="container">
    {showHead && (
      <header class="faq__head">
        <h2 id={`${listId}-title`} class="faq__title h2">
          {title}
        </h2>
        {sub && <p class="faq__sub text-muted">{sub}</p>}
      </header>
    )}

    <div class="faq__list" role="list" id={listId}>
      {items.map((it, idx) => {
        const answerId = `${listId}-a-${idx}`;

        return (
          <details class="faq__item" role="listitem">
            <summary
              class="faq__summary"
              aria-controls={answerId}
              aria-expanded="false"
            >
              <span class="faq__q">{it.q}</span>
              <svg
                class="faq__chev"
                viewBox="0 0 24 24"
                width="20"
                height="20"
                aria-hidden="true"
                focusable="false"
              >
                <path
                  d="M6 9l6 6 6-6"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                />
              </svg>
            </summary>
            <div id={answerId} class="faq__a">
              <p set:html={it.a}></p>
            </div>
          </details>
        );
      })}
    </div>
  </div>

  {faqSchema && (
    <script type="application/ld+json">
      {JSON.stringify(faqSchema)}
    </script>
  )}

  {items.length > 0 && (
    <script>
      {`
        (() => {
          const rootId = ${JSON.stringify(listId)};
          const root = document.getElementById(/* astro:sanitize */ rootId);
          if (!root) return;

          const items = Array.from(
            root.querySelectorAll('details.faq__item')
          );
          if (!items.length) return;

          const summaries = items.map((d) =>
            d.querySelector('summary')
          );

          const syncExpanded = () => {
            items.forEach((d, index) => {
              const summary = summaries[index];
              if (!summary) return;
              summary.setAttribute('aria-expanded', String(d.open));
            });
          };

          const openExclusive = (target) => {
            items.forEach((d) => {
              if (d === target) {
                if (!d.open) {
                  d.setAttribute('open', '');
                }
              } else if (d.open) {
                d.removeAttribute('open');
              }
            });
            syncExpanded();
          };

          const handleToggleIntent = (detailsEl) => {
            if (!detailsEl) return;
            const isOpening = !detailsEl.open;
            if (isOpening) {
              openExclusive(detailsEl);
            } else {
              // Closing currently open item – end with 0 open.
              detailsEl.removeAttribute('open');
              syncExpanded();
            }
          };

          // Click interaction
          root.addEventListener('click', (event) => {
            const target = event.target;
            if (!(target instanceof Element)) return;

            const summary = target.closest('summary.faq__summary');
            if (!summary || !root.contains(summary)) return;

            event.preventDefault();
            const detailsEl = summary.parentElement;
            if (!detailsEl || detailsEl.tagName !== 'DETAILS') return;

            handleToggleIntent(detailsEl);
          });

          // Keyboard interaction (Enter / Space on summary)
          root.addEventListener('keydown', (event) => {
            const target = event.target;
            if (!(target instanceof Element)) return;

            if (event.key !== 'Enter' && event.key !== ' ') return;

            const summary = target.closest('summary.faq__summary');
            if (!summary || !root.contains(summary)) return;

            event.preventDefault();
            const detailsEl = summary.parentElement;
            if (!detailsEl || detailsEl.tagName !== 'DETAILS') return;

            handleToggleIntent(detailsEl);
          });

          // Initial state sync (supports server-rendered [open])
          syncExpanded();
        })();
      `}
    </script>
  )}
</section>
