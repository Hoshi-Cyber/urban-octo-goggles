---
import "./FAQAccordion.css";

/**
 * FAQAccordion â€” premium, a11y-first, single-active accordion
 *
 * Suggested props:
 *  items: Array<{ id: string; question: string; answer: string }>
 *
 * Backwards-compatible props (legacy):
 *  items: Array<{ q?: string; a?: string }>
 *
 * Optional:
 *  title?: string
 *  sub?: string
 *  class?: string
 *  schema?: boolean          // emit FAQPage JSON-LD (default: true)
 *  showHead?: boolean        // render section heading (default: true)
 */

export interface FAQItemInput {
  id?: string;
  question?: string;
  answer?: string;
  q?: string;
  a?: string;
}

export interface Props {
  items: FAQItemInput[];
  title?: string;
  sub?: string;
  class?: string;
  schema?: boolean;
  showHead?: boolean;
}

const {
  items = [],
  title = "Frequently asked questions",
  sub,
  class: className = "",
  schema = true,
  showHead = true,
} = Astro.props as Props;

// Unique id per instance for headings / JS root
const instanceId = `faq-acc-${Math.random().toString(36).slice(2, 8)}`;

// Normalise items and drop empties
type NormalisedItem = {
  id: string;
  question: string;
  answerHtml: string;
};

const normalisedItems: NormalisedItem[] = (Array.isArray(items) ? items : [])
  .map((raw, index) => {
    const question =
      (typeof raw.question === "string" && raw.question.trim()) ||
      (typeof raw.q === "string" && raw.q.trim()) ||
      "";
    const answerHtml =
      (typeof raw.answer === "string" && raw.answer.trim()) ||
      (typeof raw.a === "string" && raw.a.trim()) ||
      "";

    if (!question || !answerHtml) return null;

    const baseId =
      typeof raw.id === "string" && raw.id.trim().length > 0
        ? raw.id.trim()
        : `${instanceId}-item-${index + 1}`;

    return {
      id: baseId,
      question,
      answerHtml,
    };
  })
  .filter(Boolean) as NormalisedItem[];

// Structured data (FAQPage)
const schemaEntities =
  schema && normalisedItems.length > 0
    ? normalisedItems.map((it) => {
        const plain = it.answerHtml
          .replace(/<[^>]+>/g, " ")
          .replace(/\s+/g, " ")
          .trim();

        return {
          "@type": "Question",
          name: it.question,
          acceptedAnswer: {
            "@type": "Answer",
            text: plain,
          },
        };
      })
    : [];

const faqSchema =
  schema && schemaEntities.length > 0
    ? {
        "@context": "https://schema.org",
        "@type": "FAQPage",
        mainEntity: schemaEntities,
      }
    : null;
---

<section
  class={`faq-accordion section ${className}`.trim()}
  data-component="faq-accordion"
  aria-labelledby={showHead ? `${instanceId}-title` : undefined}
>
  <div class="container">
    {showHead && (
      <header class="faq-accordion__head section-head stack">
        <h2 id={`${instanceId}-title`} class="section-title">
          {title}
        </h2>
        {sub && <p class="section-sub text-muted">{sub}</p>}
      </header>
    )}

    <div
      class="faq-accordion__list"
      role="list"
      data-faq-instance={instanceId}
    >
      {normalisedItems.map((item) => {
        const summaryId = `${item.id}-summary`;
        const panelId = `${item.id}-panel`;

        return (
          <details
            class="faq-accordion__item card"
            role="listitem"
            data-faq-item-id={item.id}
          >
            <summary
              id={summaryId}
              class="faq-accordion__summary"
              aria-controls={panelId}
              aria-expanded="false"
            >
              <span class="faq-accordion__q">
                {item.question}
              </span>
              <span
                class="faq-accordion__icon"
                aria-hidden="true"
              >
                <svg
                  class="faq-accordion__chevron"
                  viewBox="0 0 24 24"
                  width="20"
                  height="20"
                  focusable="false"
                >
                  <path
                    d="M6 9l6 6 6-6"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                </svg>
              </span>
            </summary>
            <div
              id={panelId}
              class="faq-accordion__panel prose"
              role="region"
              aria-labelledby={summaryId}
            >
              <div set:html={item.answerHtml}></div>
            </div>
          </details>
        );
      })}
    </div>
  </div>

  {faqSchema && (
    <script type="application/ld+json">
      {JSON.stringify(faqSchema)}
    </script>
  )}

  {normalisedItems.length > 0 && (
    <script>
      {`
        (() => {
          const ROOT_SELECTOR = '[data-faq-instance="${instanceId}"]';

          const init = () => {
            const root = document.querySelector(ROOT_SELECTOR);
            if (!root) return;

            const items = Array.from(
              root.querySelectorAll('details.faq-accordion__item')
            );
            if (!items.length) return;

            const summaries = items.map((details) =>
              details.querySelector('.faq-accordion__summary')
            );

            const syncExpanded = () => {
              items.forEach((details, index) => {
                const summary = summaries[index];
                if (!summary) return;
                summary.setAttribute(
                  'aria-expanded',
                  String(details.hasAttribute('open'))
                );
              });
            };

            const openExclusive = (target) => {
              items.forEach((details) => {
                if (details === target) {
                  details.setAttribute('open', '');
                } else if (details.hasAttribute('open')) {
                  details.removeAttribute('open');
                }
              });
              syncExpanded();
            };

            const handleToggleIntent = (details) => {
              if (!details) return;
              const willOpen = !details.hasAttribute('open');

              if (willOpen) {
                openExclusive(details);
              } else {
                details.removeAttribute('open');
                syncExpanded();
              }
            };

            // Click interaction
            root.addEventListener('click', (event) => {
              const target = event.target;
              if (!target || !(target instanceof Element)) return;

              const summary = target.closest('.faq-accordion__summary');
              if (!summary || !root.contains(summary)) return;

              event.preventDefault();
              const details = summary.closest('details.faq-accordion__item');
              if (!details) return;

              handleToggleIntent(details);
            });

            // Keyboard interaction: Enter / Space on summary
            root.addEventListener('keydown', (event) => {
              const target = event.target;
              if (!target || !(target instanceof Element)) return;

              if (event.key !== 'Enter' && event.key !== ' ') return;

              const summary = target.closest('.faq-accordion__summary');
              if (!summary || !root.contains(summary)) return;

              event.preventDefault();
              const details = summary.closest('details.faq-accordion__item');
              if (!details) return;

              handleToggleIntent(details);
            });

            // Ensure only one item is open if any were pre-opened
            const initiallyOpen = items.filter((d) => d.hasAttribute('open'));
            if (initiallyOpen.length > 1) {
              openExclusive(initiallyOpen[0]);
            } else {
              syncExpanded();
            }
          };

          if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init, { once: true });
          } else {
            init();
          }
        })();
      `}
    </script>
  )}
</section>
