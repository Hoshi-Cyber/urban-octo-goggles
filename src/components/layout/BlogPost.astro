---
// src/components/layout/BlogPost.astro
import BaseLayout from "./BaseLayout.astro";

// Blog components
import PostHeader from "../blog/compose/PostHeader/index.astro";
import PostMeta from "../blog/compose/PostMeta/index.astro";
import PostTags from "../blog/compose/PostTags/index.astro";
import PostCover from "../blog/compose/PostCover/index.astro";
import PostCTAs from "../blog/compose/PostCTAs/index.astro";

// UI
import Badge from "../ui/Badge/index.astro";

// Styles as URLs for head-slot injection
import sheetUrl from "./BlogPost.css?url";
import proseCssUrl from "../../styles/prose.css?url";

export interface Cover {
  src: string;
  alt?: string;
  width?: number;
  height?: number;
}
export interface SEO {
  canonical?: string;
  title?: string;
  description?: string;
  [key: string]: any;
}
export interface CTA {
  label: string;
  url: string;
}
export interface Props {
  title: string;
  description?: string;
  seo?: SEO;
  canonical?: string;      // may arrive from MD frontmatter
  ogImage?: string;
  date?: string | Date;
  updated?: string | Date;
  author?: string;
  readingTime?: number;
  readingTimeMinutes?: number; // alias
  tags?: string[];
  cover?: Cover | null;
  ctaPrimary?: CTA;
  ctaSecondary?: CTA;

  // optional breadcrumb inputs
  category?: string;
  categoryUrl?: string;
}

const props = Astro.props as Props;

const {
  title,
  description = "",
  author,
  tags = [],
  ctaPrimary,
  ctaSecondary,
  category,
  categoryUrl,
} = props;

// reading time normalization
const readingTime =
  typeof props.readingTime === "number"
    ? props.readingTime
    : typeof props.readingTimeMinutes === "number"
    ? props.readingTimeMinutes
    : undefined;

// dates
const publishedDate = props.date ? new Date(props.date) : null;
const updatedDate = props.updated ? new Date(props.updated) : publishedDate;

const isoPublished = publishedDate ? publishedDate.toISOString() : null;
const isoModified = updatedDate ? updatedDate.toISOString() : null;

const displayDate = publishedDate
  ? new Intl.DateTimeFormat("en-GB", { year: "numeric", month: "long", day: "numeric" }).format(
      publishedDate
    )
  : null;

const tagList = (tags || []).slice(0, 12);

// canonical
const siteUrl = Astro.site?.toString().replace(/\/$/, "") || "";
const fmCanonical = props.canonical;
const seoIn = props.seo ?? {};
const canonicalSrc = seoIn.canonical ?? fmCanonical ?? Astro.url.pathname;
const canonical =
  canonicalSrc && canonicalSrc.startsWith("http") ? canonicalSrc : `${siteUrl}${canonicalSrc ?? ""}`;

// cover inference
let cover: Cover | null = props.cover ?? null;
if (!cover && typeof props.ogImage === "string" && props.ogImage.trim()) {
  cover = { src: props.ogImage.trim(), alt: title };
}

// json-ld (Article)
const jsonLd = {
  "@context": "https://schema.org",
  "@type": "Article",
  headline: title,
  datePublished: isoPublished || undefined,
  dateModified: isoModified || undefined,
  author: author ? { "@type": "Person", name: author } : undefined,
  image: cover?.src ? `${siteUrl}${cover.src}` : undefined,
  mainEntityOfPage: canonical,
  description: description || seoIn?.description,
};

// helpers
const showUpdatedBadge =
  publishedDate && updatedDate && updatedDate.getTime() > publishedDate.getTime();

// breadcrumb data (UI + JSON-LD)
const crumbs = [
  { label: "Blog", href: "/blog" },
  ...(category
    ? [{ label: category, href: categoryUrl && categoryUrl.startsWith("/") ? categoryUrl : `/blog/category/${encodeURIComponent(category!.toLowerCase())}` }]
    : []),
  { label: title, href: canonical }
];

const breadcrumbJsonLd = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  itemListElement: crumbs.map((c, i) => ({
    "@type": "ListItem",
    position: i + 1,
    name: c.label,
    item: c.href.startsWith("http") ? c.href : `${siteUrl}${c.href}`
  }))
};
---
<BaseLayout title={title} description={description} seo={{ ...seoIn, canonical }}>
  {/* Inject page-specific assets into <head> via BaseLayout head slot */}
  <fragment slot="head">
    <link rel="stylesheet" href={sheetUrl} />
    <link rel="stylesheet" href={proseCssUrl} />
    <script type="application/ld+json">{JSON.stringify(jsonLd)}</script>
    <script type="application/ld+json">{JSON.stringify(breadcrumbJsonLd)}</script>
  </fragment>

  <article class="post container" itemscope itemtype="https://schema.org/Article">
    {/* Breadcrumbs */}
    <nav class="post__breadcrumbs" aria-label="Breadcrumb">
      <ol>
        {crumbs.slice(0, -1).map((c) => (
          <li><a href={c.href}>{c.label}</a></li>
        ))}
        <li aria-current="page">{crumbs[crumbs.length - 1].label}</li>
      </ol>
    </nav>

    {/* Header stack */}
    <PostHeader title={title} eyebrow="Blog" />

    {showUpdatedBadge && (
      <p class="post__updated">
        <Badge title="Content updated">
          Updated {new Intl.DateTimeFormat("en-GB", { year: "numeric", month: "long", day: "numeric" }).format(updatedDate!)}
        </Badge>
      </p>
    )}

    <PostMeta
      date={publishedDate ?? undefined}
      updated={updatedDate ?? undefined}
      author={author}
      readingTime={typeof readingTime === "number" && readingTime > 0 ? readingTime : undefined}
    />

    {tagList.length > 0 && <PostTags tags={tagList} variant="header" />}

    {/* Cover image */}
    {cover?.src && (
      <PostCover
        src={cover.src}
        alt={cover.alt ?? ""}
        width={cover.width ?? 1280}
        height={cover.height ?? 720}
      />
    )}

    {/* Inline CTAs early */}
    {(ctaPrimary || ctaSecondary) && (
      <PostCTAs
        primary={ctaPrimary ? { label: ctaPrimary.label, url: ctaPrimary.url } : undefined}
        secondary={ctaSecondary ? { label: ctaSecondary.label, url: ctaSecondary.url } : undefined}
      />
    )}

    {/* Article body */}
    <section class="post__content prose" itemprop="articleBody">
      <slot />
    </section>

    {/* Footer tags */}
    {tagList.length > 0 && (
      <footer class="post__footer">
        <PostTags tags={tagList} variant="footer" />
      </footer>
    )}
  </article>
</BaseLayout>
