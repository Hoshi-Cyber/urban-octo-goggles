---
/** 
 * File: src/components/layout/BaseLayout.astro
 * Fix Plan 187: Robust canonical resolver + unified usage
 * Fix Plan 204: OG image + dimensions + Twitter image support
 */

import MainNav from "./Nav/index.astro";
import Footer from "./Footer/index.astro";
// CookieBanner intentionally not imported while banner is disabled
import siteConfig from "@/site.config";

// Global CSS emitted URL (fixes CSS 404 from hardcoded public path)
import globalCssUrl from "../../styles/index.css?url";

export interface SEO {
  canonical?: string;
  ogImage?: string;
  ogImageWidth?: string;
  ogImageHeight?: string;
  twitterImage?: string;
  [key: string]: any;
}

export interface Props {
  title?: string;
  description?: string;
  canonical?: string | null;
  relPrev?: string | null;
  relNext?: string | null;
  seo?: SEO | Record<string, unknown>;
}

const {
  title = "",
  description = "",
  canonical: inCanonical = null,
  relPrev = null,
  relNext = null,
  seo = {},
} = Astro.props as Props;

// Single canonical page title used everywhere
const pageTitle: string = String(title).trim() || "CV Writing Kenya";

// Env + site
const isDev = import.meta.env.DEV;

// Base URL from config (trim trailing slash)
const siteUrl: string =
  (siteConfig as any)?.siteUrl?.toString().replace(/\/$/, "") || "";

/**
 * Helper: coerce any input into an absolute URL string.
 * - Accepts string | URL | anything else (falls back to String(value)).
 * - Never calls .startsWith on a non-string.
 */
function toAbsolute(input: unknown): string {
  if (input == null) return "";

  // Normalise to string first
  let u: string;
  if (typeof input === "string") {
    u = input;
  } else if (input instanceof URL) {
    u = input.href;
  } else {
    u = String(input);
  }

  u = u.trim();
  if (!u) return "";

  // Already absolute http(s)
  if (u.startsWith("http://") || u.startsWith("https://")) {
    return u;
  }

  // If we have a configured siteUrl, resolve relative to that
  if (siteUrl) {
    return siteUrl + (u.startsWith("/") ? u : `/${u}`);
  }

  // No base configured â€“ return as-is, but ensure it looks like a path
  return u.startsWith("/") ? u : `/${u}`;
}

// Derive current path from Astro.url safely
let currentPath = "/";
try {
  const urlVal: any = Astro.url;
  if (urlVal instanceof URL) {
    currentPath = urlVal.pathname || "/";
  } else if (typeof urlVal === "string") {
    // If Astro.url were ever a string, strip origin if present
    const parsed = new URL(urlVal, "http://localhost");
    currentPath = parsed.pathname || "/";
  }
} catch {
  currentPath = "/";
}

// Compute canonical (single source of truth)
const pageCanonical: string =
  typeof inCanonical === "string" && inCanonical.trim()
    ? toAbsolute(inCanonical.trim())
    : toAbsolute(currentPath);

// Prev/Next (resolve to absolute if relative)
function absOrRel(href: string | null): string | null {
  if (!href) return null;
  return toAbsolute(href);
}
const prevHref = absOrRel(relPrev);
const nextHref = absOrRel(relNext);

// OG / Twitter images (Fix Plan 204)
const seoAny = seo as any;

// Base OG image path, defaulting to logo-square when not provided
const ogImageIn = seoAny?.ogImage as unknown;
const rawOgImage =
  typeof ogImageIn === "string" && ogImageIn.trim()
    ? ogImageIn.trim()
    : "/assets/logos/logo-square-512.png";

const ogImage = isDev ? rawOgImage : toAbsolute(rawOgImage);

// Optional, overridable dimensions (used especially for /blog OG)
const ogImageWidth: string =
  typeof seoAny?.ogImageWidth === "string" && seoAny.ogImageWidth.trim()
    ? seoAny.ogImageWidth.trim()
    : "1200";
const ogImageHeight: string =
  typeof seoAny?.ogImageHeight === "string" && seoAny.ogImageHeight.trim()
    ? seoAny.ogImageHeight.trim()
    : "630";

// Twitter image (defaults to OG image if not explicitly set)
const twitterImageIn = seoAny?.twitterImage as unknown;
const rawTwitterImage =
  typeof twitterImageIn === "string" && twitterImageIn.trim()
    ? twitterImageIn.trim()
    : rawOgImage;
const twitterImage = isDev ? rawTwitterImage : toAbsolute(rawTwitterImage);

// IDs
const ga4Id: string | undefined =
  (siteConfig as any).ga4Id || (siteConfig as any).measurementId;
const gtmId: string | undefined = (siteConfig as any).gtmId;
---

<!DOCTYPE html>
<html lang="en" data-gtm={gtmId}>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>{pageTitle}</title>
    {description && <meta name="description" content={description} />}

    <link rel="canonical" href={pageCanonical} />
    {prevHref && <link rel="prev" href={prevHref} />}
    {nextHref && <link rel="next" href={nextHref} />}

    <!-- Global CSS (served from emitted URL) -->
    <link rel="stylesheet" href={globalCssUrl} />

    <!-- Hints -->
    <link
      rel="preconnect"
      href="https://www.googletagmanager.com"
      crossorigin
    />
    <link rel="dns-prefetch" href="https://www.googletagmanager.com" />

    <!-- Favicons -->
    <link rel="icon" href="/assets/logos/favicon.ico" />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="/assets/logos/favicon-32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="/assets/logos/favicon-16.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="/assets/logos/apple-touch-icon-180.png"
    />

    <!-- Open Graph -->
    <meta property="og:site_name" content="CV Writing Kenya" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content={pageTitle} />
    {description && <meta property="og:description" content={description} />}
    <meta property="og:url" content={pageCanonical} />
    <meta property="og:image" content={ogImage} />
    {ogImageWidth && <meta property="og:image:width" content={ogImageWidth} />}
    {ogImageHeight && (
      <meta property="og:image:height" content={ogImageHeight} />
    )}

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:image" content={twitterImage} />

    <!-- Surface GA4 ID for client-side analytics bootstrap -->
    {ga4Id && <meta name="x-ga4-id" content={ga4Id} />}

    <!-- Optional per-page head injection -->
    <slot name="head" />
  </head>
  <body class="flex min-h-screen flex-col">
    {gtmId && (
      <noscript>
        <iframe
          src={"https://www.googletagmanager.com/ns.html?id=" + gtmId}
          height="0"
          width="0"
          style="display:none;visibility:hidden"
        >
        </iframe>
      </noscript>
    )}

    <a href="#main" class="skip-link">Skip to main content</a>

    <MainNav />
    <main
      id="main"
      class="flex-grow page-content"
      role="main"
      tabindex="-1"
      data-section="main"
      data-title={pageTitle}
    >
      <slot />
    </main>

    <Footer />
    {/*
      CookieBanner temporarily disabled during local development.
      Re-enable by importing CookieBanner above and inserting:
      <CookieBanner />
    */}

    <!-- Analytics bootstrap only; cookie-banner wiring disabled for now -->
    <script type="module">
      import "@/lib/analytics.ts";
    </script>
  </body>
</html>
