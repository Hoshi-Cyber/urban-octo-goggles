---
/** File: src/components/layout/BaseLayout.astro
    Fix Plan 187: Robust canonical resolver + unified usage
*/

import MainNav from "./Nav/index.astro";
import Footer from "./Footer/index.astro";
import CookieBanner from "../CookieBanner/index.astro";
import siteConfig from "@/site.config";

// Global CSS emitted URL (fixes CSS 404 from hardcoded public path)
import globalCssUrl from "../../styles/index.css?url";

export interface SEO {
  canonical?: string;
  ogImage?: string;
  [key: string]: any;
}
export interface Props {
  title?: string;
  description?: string;
  canonical?: string | null;
  relPrev?: string | null;
  relNext?: string | null;
  seo?: SEO | Record<string, unknown>;
}

const {
  title = "",
  description = "",
  canonical: inCanonical = null,
  relPrev = null,
  relNext = null,
  seo = {},
} = Astro.props as Props;

// Single canonical page title used everywhere
const pageTitle: string = (String(title).trim() || "CV Writing Kenya");

// Env + site
const isDev = import.meta.env.DEV;

// Base URL from config (trim trailing slash)
const siteUrl: string = (siteConfig as any)?.siteUrl?.replace(/\/$/, "") || "";

// Helper: make absolute URL
function toAbsolute(u: string): string {
  if (!u) return "";
  try {
    // Already absolute?
    return new URL(u).href;
  } catch {
    // Resolve against configured siteUrl if available; else leave as-is
    return siteUrl ? siteUrl + (u.startsWith("/") ? u : `/${u}`) : u;
  }
}

// Compute canonical (single source of truth)
const pageCanonical: string =
  (typeof inCanonical === "string" && inCanonical.trim())
    ? toAbsolute(inCanonical.trim())
    : (siteUrl ? siteUrl + Astro.url.pathname : Astro.url.href);

// Prev/Next (resolve to absolute if relative)
function absOrRel(href: string | null): string | null {
  if (!href) return null;
  return toAbsolute(href);
}
const prevHref = absOrRel(relPrev);
const nextHref = absOrRel(relNext);

// OG image
const ogImageIn = (seo as any)?.ogImage as string | undefined;
const ogImage = isDev
  ? (ogImageIn || "/assets/logos/logo-square-512.png")
  : (ogImageIn ? toAbsolute(ogImageIn) : toAbsolute("/assets/logos/logo-square-512.png"));

// IDs
const ga4Id: string | undefined =
  (siteConfig as any).ga4Id || (siteConfig as any).measurementId;
const gtmId: string | undefined = (siteConfig as any).gtmId;
---

<!DOCTYPE html>
<html lang="en" data-gtm={gtmId}>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>{pageTitle}</title>
    {description && <meta name="description" content={description} />}

    <link rel="canonical" href={pageCanonical} />
    {prevHref && <link rel="prev" href={prevHref} />}
    {nextHref && <link rel="next" href={nextHref} />}

    <!-- Global CSS (served from emitted URL) -->
    <link rel="stylesheet" href={globalCssUrl} />

    <!-- Hints -->
    <link rel="preconnect" href="https://www.googletagmanager.com" crossorigin />
    <link rel="dns-prefetch" href="https://www.googletagmanager.com" />

    <!-- Favicons -->
    <link rel="icon" href="/assets/logos/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/logos/favicon-32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/logos/favicon-16.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/logos/apple-touch-icon-180.png" />

    <!-- Open Graph -->
    <meta property="og:site_name" content="CV Writing Kenya" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content={pageTitle} />
    {description && <meta property="og:description" content={description} />}
    <meta property="og:url" content={pageCanonical} />
    <meta property="og:image" content={ogImage} />

    <!-- Surface GA4 ID for client-side analytics bootstrap -->
    {ga4Id && <meta name="x-ga4-id" content={ga4Id} />}

    <!-- Optional per-page head injection -->
    <slot name="head" />
  </head>
  <body class="flex min-h-screen flex-col">
    {gtmId && (
      <noscript>
        <iframe
          src={"https://www.googletagmanager.com/ns.html?id=" + gtmId}
          height="0"
          width="0"
          style="display:none;visibility:hidden">
        </iframe>
      </noscript>
    )}

    <a href="#main" class="skip-link">Skip to main content</a>

    <MainNav />
    <main
      id="main"
      class="flex-grow page-content"
      role="main"
      tabindex="-1"
      data-section="main"
      data-title={pageTitle}
    >
      <slot />
    </main>

    <Footer />
    <CookieBanner />

    <!-- Consent-mode analytics bootstrap -->
    <script type="module" src="/src/lib/analytics.ts"></script>
  </body>
</html>
