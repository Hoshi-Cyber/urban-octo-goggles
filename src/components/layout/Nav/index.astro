---
import navItems from "../../../data/nav.json";
import "./Nav.css";
import { slug } from "@/utils/slug";

/** Nav — mobile-first, accessible (Fix Plan 64 + Fix Plan 128) */
export interface Props {
  class?: string;
}

const { class: className = "" } = Astro.props as Props;

const cta = navItems.find((i: any) => i.cta);
const main = navItems.filter((i: any) => !i.cta);

/** Canonicalize blog links and enforce slug rules */
const normalizeHref = (href: string) => {
  if (!href) return href;
  try {
    const site = (Astro.site && Astro.site.toString()) || "/";
    const u = new URL(href, site);
    let p = u.pathname.replace(/\/{2,}/g, "/");

    // /blog/category/<cat>/ → /blog/<slug>/
    const mCat = p.match(/^\/blog\/category\/([^/]+)\/?$/);
    if (mCat) {
      p = `/blog/${slug(decodeURIComponent(mCat[1]))}/`;
    } else {
      // /blog/tag/<tag>/ → /blog/tag/<slug>/
      const mTag = p.match(/^\/blog\/tag\/([^/]+)\/?$/);
      if (mTag) {
        p = `/blog/tag/${slug(decodeURIComponent(mTag[1]))}/`;
      }
    }

    // Ensure trailing slash on /blog paths
    if (/^\/blog(\/.*)?$/.test(p) && !p.endsWith("/")) p = p + "/";

    u.pathname = p;
    u.search = "";
    u.hash = "";
    return u.toString().replace(site, site.endsWith("/") ? site : site + "");
  } catch {
    return href;
  }
};
---
<header
  class={`nav sticky top-0 z-50 ${className}`.trim()}
  role="banner"
  data-section="nav"
>
  <div class="nav__frame">
    <div class="container nav__bar">
      <!-- Brand: single icon + typed logotype -->
      <a
        href="/"
        class="nav__brand"
        aria-label="CVWriting.co.ke home"
        data-cta="brand"
      >
        <img
          class="nav__brandIcon"
          src="/assets/logos/favicon-321.png"
          width="28"
          height="28"
          alt=""
          decoding="async"
          fetchpriority="high"
        />
        <span class="nav__brandText" aria-hidden="true">CVWriting</span>
        <span class="sr-only">CVWriting.co.ke</span>
      </a>

      <!-- Desktop nav -->
      <nav class="nav__primary" aria-label="Main">
        <ul class="nav__list" role="menubar">
          {main.map((item: any) =>
            !item.children ? (
              <li class="nav__item" role="none">
                <a
                  href={normalizeHref(item.href)}
                  role="menuitem"
                  class="nav__link"
                  data-cta={`nav-${item.label.toLowerCase()}`}
                >
                  {item.label}
                </a>
              </li>
            ) : (
              <li class="nav__item nav__item--hasChildren" role="none">
                <button
                  class="nav__link nav__disclosure"
                  type="button"
                  role="menuitem"
                  aria-haspopup="true"
                  aria-expanded="false"
                  aria-controls={`submenu-${item.label
                    .toLowerCase()
                    .replace(/\s+/g, "-")}`}
                  data-cta={`nav-${item.label.toLowerCase()}`}
                >
                  {item.label}
                  <span class="nav__chev" aria-hidden="true">▾</span>
                </button>
                <ul
                  id={`submenu-${item.label
                    .toLowerCase()
                    .replace(/\s+/g, "-")}`}
                  class="nav__submenu"
                  role="menu"
                >
                  {item.children.map((child: any) => (
                    <li role="none">
                      <a
                        href={normalizeHref(child.href)}
                        role="menuitem"
                        class="nav__sublink"
                        data-cta={`nav-${item.label
                          .toLowerCase()
                          .replace(/\s+/g, "-")}-${child.label
                          .toLowerCase()
                          .replace(/\s+/g, "-")}`}
                      >
                        {child.label}
                      </a>
                    </li>
                  ))}
                </ul>
              </li>
            )
          )}
        </ul>
      </nav>

      <!-- Desktop CTA (hidden on mobile via CSS) -->
      {cta && (
        <a
          href={normalizeHref(cta.href)}
          class="btn btn-primary nav__cta"
          data-cta="nav-cta"
        >
          <span class="btn__inner">
            <span class="btn__label">{cta.label}</span>
          </span>
        </a>
      )}

      <!-- Mobile toggle -->
      <button
        class="nav__toggle"
        id="nav-toggle"
        aria-label="Open menu"
        aria-controls="nav-drawer"
        aria-expanded="false"
        data-cta="nav-toggle"
        type="button"
      >
        <span class="nav__toggleBar" aria-hidden="true"></span>
        <span class="nav__toggleBar" aria-hidden="true"></span>
        <span class="nav__toggleBar" aria-hidden="true"></span>
      </button>
    </div>
  </div>

  <!-- Mobile scrim -->
  <div id="nav-scrim" class="nav__scrim" hidden></div>

  <!-- Mobile drawer -->
  <nav
    id="nav-drawer"
    class="nav__drawer"
    aria-label="Mobile"
    aria-modal="true"
    role="dialog"
    tabindex="-1"
  >
    <div class="nav__drawerInner">
      <div class="nav__drawerHeader">
        <a
          href="/"
          class="nav__brand nav__brand--drawer"
          aria-label="CVWriting.co.ke home"
          data-cta="mnav-brand"
        >
          <img
            class="nav__brandIcon"
            src="/assets/logos/favicon-321.png"
            width="24"
            height="24"
            alt=""
            decoding="async"
          />
          <span class="nav__brandText" aria-hidden="true">CVWriting</span>
          <span class="sr-only">CVWriting.co.ke</span>
        </a>

        <button
          class="nav__close"
          id="nav-close"
          aria-label="Close menu"
          type="button"
        >
          ✕
        </button>
      </div>

      <ul class="nav__drawerList">
        {main.map((item: any) =>
          !item.children ? (
            <li>
              <a
                href={normalizeHref(item.href)}
                class="nav__drawerLink"
                data-cta={`mnav-${item.label.toLowerCase()}`}
              >
                {item.label}
              </a>
            </li>
          ) : (
            <li>
              <details class="nav__details">
                <summary class="nav__summary">{item.label}</summary>
                <ul class="nav__drawerSub">
                  {item.children.map((child: any) => (
                    <li>
                      <a
                        href={normalizeHref(child.href)}
                        class="nav__drawerSublink"
                        data-cta={`mnav-${item.label
                          .toLowerCase()
                          .replace(/\s+/g, "-")}-${child.label
                          .toLowerCase()
                          .replace(/\s+/g, "-")}`}
                      >
                        {child.label}
                      </a>
                    </li>
                  ))}
                </ul>
              </details>
            </li>
          )
        )}
        {cta && (
          <li class="nav__drawerCta">
            <p class="nav__drawerEyebrow">Get Started</p>
            <p class="nav__drawerTagline">
              Strategic CVs, cover letters and LinkedIn profiles for Kenyan
              professionals.
            </p>
            <a
              href={normalizeHref(cta.href)}
              class="btn btn-primary nav__drawerCtaButton"
              data-cta="mnav-cta"
            >
              <span class="btn__inner">
                <span class="btn__label">{cta.label}</span>
              </span>
            </a>
          </li>
        )}
      </ul>
    </div>
  </nav>

  <script is:inline>
    (function () {
      var scriptEl = document.currentScript;
      if (!scriptEl) return;
      var root = scriptEl.closest(".nav");
      if (!root) return;

      var toggle = root.querySelector("#nav-toggle");
      var drawer = root.querySelector("#nav-drawer");
      var scrim = root.querySelector("#nav-scrim");
      var closeBtn = root.querySelector("#nav-close");
      var links = drawer
        ? Array.prototype.slice.call(drawer.querySelectorAll("a"))
        : [];
      var disclosures = Array.prototype.slice.call(
        root.querySelectorAll(".nav__disclosure")
      );

      var submenuItems = disclosures.map(function (btn) {
        var item = btn.closest(".nav__item--hasChildren");
        var submenu = item ? item.querySelector(".nav__submenu") : null;
        return { btn: btn, item: item, submenu: submenu };
      });

      var lastFocused = null;

      function setExpanded(open) {
        if (!toggle || !drawer) return;
        var isOpen = !!open;

        if (isOpen) {
          lastFocused =
            (document.activeElement && document.activeElement instanceof HTMLElement
              ? document.activeElement
              : toggle);
        }

        toggle.setAttribute("aria-expanded", String(isOpen));
        drawer.classList.toggle("is-open", isOpen);
        document.documentElement.classList.toggle("no-scroll", isOpen);
        if (scrim) scrim.hidden = !isOpen;

        if (isOpen) {
          // Move focus into the drawer: first link, else close button, else drawer
          var focusTarget =
            drawer.querySelector(
              "a, button, [tabindex]:not([tabindex='-1'])"
            ) || closeBtn || drawer;

          if (focusTarget && typeof focusTarget.focus === "function") {
            focusTarget.focus();
          }
        } else {
          // Restore focus to previous element or toggle
          var target =
            lastFocused && document.contains(lastFocused)
              ? lastFocused
              : toggle;
          if (target && typeof target.focus === "function") {
            target.focus();
          }
        }
      }

      if (toggle) {
        toggle.addEventListener("click", function () {
          var expanded = toggle.getAttribute("aria-expanded") === "true";
          setExpanded(!expanded);
        });
      }

      if (closeBtn) {
        closeBtn.addEventListener("click", function () {
          setExpanded(false);
        });
      }

      if (scrim) {
        scrim.addEventListener("click", function () {
          setExpanded(false);
        });
      }

      // Close drawer when following a link
      links.forEach(function (a) {
        a.addEventListener("click", function () {
          setExpanded(false);
        });
      });

      // Desktop submenu disclosure logic
      function closeAllSubmenus() {
        submenuItems.forEach(function (entry) {
          var btn = entry.btn;
          var item = entry.item;
          var submenu = entry.submenu;
          btn.setAttribute("aria-expanded", "false");
          if (item) item.classList.remove("is-open");
          if (submenu) submenu.setAttribute("data-open", "false");
        });
      }

      submenuItems.forEach(function (entry) {
        var btn = entry.btn;
        var item = entry.item;
        var submenu = entry.submenu;
        if (!item) return;

        btn.addEventListener("click", function () {
          var isOpen = btn.getAttribute("aria-expanded") === "true";
          closeAllSubmenus();
          if (!isOpen) {
            btn.setAttribute("aria-expanded", "true");
            item.classList.add("is-open");
            if (submenu) submenu.setAttribute("data-open", "true");
          }
        });

        // Close when focus leaves the submenu item
        item.addEventListener("focusout", function (event) {
          var next = event.relatedTarget;
          if (!next || !item.contains(next)) {
            btn.setAttribute("aria-expanded", "false");
            item.classList.remove("is-open");
            if (submenu) submenu.setAttribute("data-open", "false");
          }
        });
      });

      // Global key handling: ESC closes drawer or any open submenu
      document.addEventListener("keydown", function (event) {
        if (event.key !== "Escape") return;

        var drawerOpen = !!drawer && drawer.classList.contains("is-open");
        if (drawerOpen) {
          setExpanded(false);
          return;
        }

        // Close any open desktop submenu
        var openItem = root.querySelector(
          ".nav__item--hasChildren.is-open"
        );
        if (openItem) {
          closeAllSubmenus();
        }
      });

      // Click-away handling for desktop submenus
      document.addEventListener("click", function (event) {
        if (!root.contains(event.target)) {
          closeAllSubmenus();
        }
      });
    })();
  </script>
</header>
