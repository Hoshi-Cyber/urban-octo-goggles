---
import "./ComparisonMatrix.css";

export interface FeatureRow {
  label: string;
  values: Array<boolean | string>; // one per plan
}

export interface Props {
  plans?: string[];
  features?: FeatureRow[];
  caption?: string;
  eyebrow?: string;
  compact?: boolean;
  wide?: boolean;
  showHead?: boolean;
}

const {
  plans,
  features,
  caption = "Compare CV writing packages",
  eyebrow = "What’s included in each package",
  compact = false,
  wide = true, // default to wide for 4-column pricing matrix
  showHead = true, // allow page to own the section heading if needed
} = Astro.props as Props;

const defaultPlans: string[] = [
  "Starter CV Pack",
  "Professional Impact Pack",
  "Advanced Growth Pack",
  "Executive Brand Suite",
];

const effectivePlans: string[] =
  Array.isArray(plans) && plans.length > 0 ? plans : defaultPlans;

const defaultFeatures: FeatureRow[] = [
  {
    label: "Ideal experience level",
    values: [
      "0–3 years (graduate / early career)",
      "3–8 years (mid-level / switchers)",
      "6–12 years (supervisors & managers)",
      "Senior executive & diaspora",
    ],
  },
  {
    label: "Professionally written CV (Word & PDF)",
    values: [true, true, true, true],
  },
  {
    label: "ATS optimization for Kenyan job boards",
    values: [true, true, true, true],
  },
  {
    label: "Cover letter",
    values: [
      "Basic cover letter",
      "Tailored cover letter for main target role",
      "Custom cover letter for primary target role",
      "Executive-level cover letter aligned to leadership roles",
    ],
  },
  {
    label: "LinkedIn support",
    values: [
      "Not included",
      "Headline & summary refresh",
      "Full LinkedIn profile optimization",
      "Full LinkedIn revamp (about, experience, skills, structure)",
    ],
  },
  {
    label: "Career statement / personal brand",
    values: [
      "Not included",
      "Not included",
      "Career statement & positioning narrative",
      "Leadership brand statement & positioning",
    ],
  },
  {
    label: "Global keyword strategy (Kenya + international roles)",
    values: [false, false, false, true],
  },
  {
    label: "Revision window",
    values: [
      "Up to 2 revisions within 7 days",
      "Up to 2 revisions within 10 days",
      "Revisions during project window",
      "Priority edits during engagement window",
    ],
  },
];

const effectiveFeatures: FeatureRow[] =
  Array.isArray(features) && features.length > 0 ? features : defaultFeatures;

const cmatrixClasses =
  "cmatrix" +
  (compact ? " cmatrix--compact" : "") +
  (wide ? " cmatrix--wide" : "");

// Normalized plan labels (keep length, avoid undefined in ARIA/labels)
const planLabels = Array.isArray(effectivePlans)
  ? effectivePlans.map((plan, index) => {
      if (typeof plan === "string") {
        const trimmed = plan.trim();
        return trimmed.length > 0 ? trimmed : `Package ${index + 1}`;
      }
      return `Package ${index + 1}`;
    })
  : [];

// Choose the “Most popular” column (Professional Impact Pack / second plan by default)
const mostPopularIndex =
  planLabels.length >= 3 ? 1 : planLabels.length > 0 ? 0 : -1;

// Scroll region label – ties back to caption
const scrollRegionLabel = `${caption} – scroll horizontally to compare packages`;
---

<section
  class={cmatrixClasses}
  aria-label="CV writing package comparison"
  data-section="comparison-matrix"
>
  <div class="container">
    {showHead && (
      <header class="cmatrix__head">
        <p class="cmatrix__eyebrow">{eyebrow}</p>
        <h2 class="h2 cmatrix__title">{caption}</h2>
      </header>
    )}

    {/* Framed, scrollable region on small screens */}
    <div
      class="cmatrix__wrap"
      role="region"
      aria-label={scrollRegionLabel}
      tabindex="0"
    >
      <table class="cmatrix__table">
        <caption class="sr-only">{caption}</caption>

        {/* Column model: first column = feature; remaining plan columns divide evenly */}
        <colgroup>
          <col class="cmatrix__col cmatrix__col--feat" />
          {planLabels.map(() => (
            <col class="cmatrix__col cmatrix__col--plan" />
          ))}
        </colgroup>

        <thead class="cmatrix__thead">
          <tr>
            <th scope="col" class="cmatrix__headcell cmatrix__featcol">
              <span class="cmatrix__headlabel">Deliverable / feature</span>
            </th>

            {planLabels.map((planLabel, index) => {
              const isPopular = index === mostPopularIndex;

              return (
                <th
                  scope="col"
                  class={
                    "cmatrix__headcell cmatrix__plancol" +
                    (isPopular ? " cmatrix__plancol--popular" : "")
                  }
                  data-plan={planLabel}
                >
                  {isPopular && (
                    <span class="cmatrix__plan-pill">Most popular</span>
                  )}
                  <span class="cmatrix__plan-name">{planLabel}</span>
                </th>
              );
            })}
          </tr>
        </thead>

        <tbody>
          {effectiveFeatures.map((row) => {
            const featureLabel =
              typeof row.label === "string" && row.label.trim().length > 0
                ? row.label.trim()
                : "Feature";

            return (
              <tr class="cmatrix__row">
                <th
                  scope="row"
                  class="cmatrix__feat"
                  data-feature={featureLabel}
                >
                  <span class="cmatrix__feature-label">{featureLabel}</span>
                </th>

                {/* Drive cells by plans so header and body stay aligned */}
                {planLabels.map((planLabel, index) => {
                  const value = row.values?.[index];
                  const isPopular = index === mostPopularIndex;

                  const baseCellClass =
                    "cmatrix__cell" +
                    (isPopular ? " cmatrix__cell--popular" : "");

                  if (typeof value === "boolean") {
                    const ariaPlanName = planLabel;
                    const cellLabel = value
                      ? `Included in ${ariaPlanName}`
                      : `Not included in ${ariaPlanName}`;

                    return (
                      <td class={baseCellClass} data-plan={planLabel}>
                        {value ? (
                          <span class="cmatrix__check" aria-label={cellLabel}>
                            <svg viewBox="0 0 20 20" aria-hidden="true">
                              <path d="M7.5 13.2 4.8 10.6l-1.3 1.3 4 4 9-9-1.3-1.3-7.7 7.7z" />
                            </svg>
                          </span>
                        ) : (
                          <span class="cmatrix__cross" aria-label={cellLabel}>
                            <svg viewBox="0 0 20 20" aria-hidden="true">
                              <path d="M5.6 4.9 4.9 5.6l4.4 4.4-4.4 4.4.7.7 4.4-4.4 4.4 4.4.7-.7-4.4-4.4 4.4-4.4-.7-.7-4.4 4.4-4.4-4.4z" />
                            </svg>
                          </span>
                        )}
                      </td>
                    );
                  }

                  // Graceful handling for missing / non-boolean string-like values
                  if (value === null || value === undefined || value === "") {
                    return (
                      <td class={baseCellClass} data-plan={planLabel}></td>
                    );
                  }

                  return (
                    <td class={baseCellClass} data-plan={planLabel}>
                      <span class="cmatrix__text">{String(value)}</span>
                    </td>
                  );
                })}
              </tr>
            );
          })}
        </tbody>
      </table>
    </div>

    <p class="cmatrix__scrollhint" aria-hidden="true">
      Swipe left or right to compare all packages.
    </p>
  </div>
</section>

<style is:global>
  @import "../../../styles/tokens.css";
  @import "../../../styles/typography.css";
  @import "../../../styles/utilities.css";
  @import "../../../styles/breakpoints.css";
</style>
