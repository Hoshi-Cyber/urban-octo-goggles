---
import "./CookieBanner.css";

type ConsentStatus = "accepted" | "declined" | "pending";

interface ConsentConfig {
  storageKey: string;
  version: number;
}

/**
 * Versioned consent config â€“ bump version if the consent model changes
 * and you want to re-ask users.
 */
const consentConfig: ConsentConfig = {
  storageKey: "cvw_cookie_consent_v1",
  version: 1,
};
---

<section
  id="cookie-banner"
  class="cookie-banner"
  role="dialog"
  aria-modal="false"
  aria-label="Cookie preferences"
  aria-live="polite"
  data-cookie-banner
>
  <div class="cookie-banner__inner card stack" data-cookie-banner-card>
    <div class="cookie-banner__body">
      <h2 class="cookie-banner__title">Privacy & cookies</h2>
      <p class="cookie-banner__text text-muted">
        We use essential cookies to run this site and optional analytics cookies to improve it.
        You can accept or decline analytics at any time. Your choice will be remembered on this
        device.
      </p>
      <p class="cookie-banner__meta text-muted">
        For full details, see our
        {' '}
        <a href="/privacy-policy" class="cookie-banner__link">Privacy Policy</a>.
      </p>
    </div>

    <div class="cookie-banner__actions">
      <button
        type="button"
        class="btn btn-primary"
        data-cookie-accept
        data-cta="cookies-accept"
      >
        Accept analytics
      </button>
      <button
        type="button"
        class="btn"
        data-cookie-decline
        data-cta="cookies-decline"
      >
        Decline
      </button>
    </div>

    <p id="cookie-banner-status" class="sr-only" aria-hidden="true">
      Cookie preferences banner. Use the buttons to accept or decline analytics cookies.
    </p>
  </div>
</section>

<script is:inline>
  (function () {
    var STORAGE_KEY = {{ JSON.stringify(consentConfig.storageKey) }};
    var STATUS_ACCEPTED = "accepted";
    var STATUS_DECLINED = "declined";
    var STATUS_PENDING = "pending";

    function safeStorage() {
      try {
        if (typeof window === "undefined") return null;
        if (!("localStorage" in window)) return null;
        return window.localStorage;
      } catch (_e) {
        return null;
      }
    }

    function getStatus() {
      var store = safeStorage();
      if (!store) return STATUS_PENDING;
      try {
        var raw = store.getItem(STORAGE_KEY);
        if (!raw) return STATUS_PENDING;
        var parsed = JSON.parse(raw);
        if (
          parsed &&
          (parsed.status === STATUS_ACCEPTED ||
            parsed.status === STATUS_DECLINED)
        ) {
          return parsed.status;
        }
      } catch (_e) {}
      return STATUS_PENDING;
    }

    function setStatus(status) {
      var store = safeStorage();
      if (!store) return;
      try {
        store.setItem(
          STORAGE_KEY,
          JSON.stringify({
            status: status,
            updatedAt: new Date().toISOString(),
          })
        );
      } catch (_e) {}
    }

    function getBanner() {
      if (typeof document === "undefined") return null;
      return document.querySelector("[data-cookie-banner]");
    }

    function showBanner() {
      var banner = getBanner();
      if (!banner) return;
      banner.removeAttribute("hidden");
      banner.classList.add("cookie-banner--visible");
    }

    function hideBanner() {
      var banner = getBanner();
      if (!banner) return;
      banner.setAttribute("hidden", "true");
      banner.classList.remove("cookie-banner--visible");
    }

    function init() {
      var banner = getBanner();
      if (!banner) return;

      // Default: visible when JS is disabled.
      // When JS is enabled, decide based on stored status.
      banner.setAttribute("hidden", "true");

      var status = getStatus();
      if (status === STATUS_PENDING) {
        showBanner();
      }

      var acceptBtn = banner.querySelector("[data-cookie-accept]");
      var declineBtn = banner.querySelector("[data-cookie-decline]");

      if (acceptBtn) {
        acceptBtn.addEventListener("click", function () {
          setStatus(STATUS_ACCEPTED);
          hideBanner();
        });
      }

      if (declineBtn) {
        declineBtn.addEventListener("click", function () {
          setStatus(STATUS_DECLINED);
          hideBanner();
        });
      }

      // Hook for "Manage Cookies" in footer (or elsewhere).
      window.openCookieBanner = function () {
        showBanner();
      };
    }

    if (typeof window !== "undefined" && typeof document !== "undefined") {
      // Astro usually injects this near the end of <body> anyway,
      // but we guard for safety.
      if (
        document.readyState === "interactive" ||
        document.readyState === "complete"
      ) {
        init();
      } else {
        document.addEventListener("DOMContentLoaded", init, { once: true });
      }
    }
  })();
</script>
