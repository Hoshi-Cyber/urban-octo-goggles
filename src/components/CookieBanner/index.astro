---
/** File: src/components/CookieBanner/index.astro
 * Fix Plan 146 — Bottom-fixed banner with reserved height to prevent CLS.
 * - Renders a spacer (.cb__reserve) so content never jumps.
 * - Height is synced to the real banner via JS (ResizeObserver).
 * - If prior choice exists, hide both banner and spacer immediately.
 */
import "./CookieBanner.css";

const storageKey = "consent.analytics.choice"; // 'granted' | 'denied'
const cookieName = "consent_analytics";        // mirrors storage for SSR/infra
---

<!-- Reserve spacer: sits in normal flow so fixed banner doesn’t cause CLS -->
<div id="cookie-banner-reserve" class="cb__reserve" aria-hidden="true"></div>

<!-- Bottom-fixed banner -->
<div
  id="cookie-banner"
  class="cb"
  role="dialog"
  aria-modal="false"
  aria-live="polite"
  aria-label="Cookie consent"
  hidden
>
  <div class="cb__inner container">
    <div class="cb__content">
      <h2 class="cb__title">We use cookies</h2>
      <p class="cb__text">
        We use analytics cookies to measure what works and improve the site. You can accept or keep analytics off.
        Change this any time from <a class="cb__link" href="/privacy">Privacy</a>.
      </p>
    </div>

    <div class="cb__actions">
      <button class="btn btn-primary" id="cb-accept" data-cta="cookies-accept">Accept analytics</button>
      <button class="btn" id="cb-decline" data-cta="cookies-decline">Decline</button>
    </div>
  </div>
</div>

<script is:inline>
  (function () {
    var KEY = "consent.analytics.choice";
    var COOKIE = "consent_analytics";

    var banner  = document.getElementById('cookie-banner');
    var reserve = document.getElementById('cookie-banner-reserve');
    var accept  = document.getElementById('cb-accept');
    var decline = document.getElementById('cb-decline');

    function getChoice() {
      try { return localStorage.getItem(KEY); } catch (_) { return null; }
    }
    function setChoice(value) {
      try { localStorage.setItem(KEY, value); } catch (_) {}
      try {
        document.cookie = COOKIE + "=" + encodeURIComponent(value)
          + "; Max-Age=" + (3600*24*365)
          + "; Path=/; SameSite=Lax";
      } catch (_) {}
    }
    function updateConsent(granted) {
      // Consent Mode v2 payload
      var payload = granted ? {
        analytics_storage: 'granted',
        ad_storage: 'granted',
        ad_user_data: 'granted',
        ad_personalization: 'granted'
      } : {
        analytics_storage: 'denied',
        ad_storage: 'denied',
        ad_user_data: 'denied',
        ad_personalization: 'denied'
      };
      (window.gtag || function(){ (window.dataLayer = window.dataLayer || []).push(arguments); })('consent', 'update', payload);
      (window.dataLayer = window.dataLayer || []).push({
        event: 'consent_choice',
        consent: granted ? 'granted' : 'denied'
      });
      // Fire site-wide hooks used by BaseLayout
      window.dispatchEvent(new CustomEvent(granted ? 'cookie:accept' : 'cookie:decline'));
      if (granted) window.dispatchEvent(new CustomEvent('cmp:accept'));
    }

    function show()  { if (banner)  banner.hidden  = false; if (reserve) reserve.hidden = false; }
    function hide()  { if (banner)  banner.hidden  = true;  if (reserve) reserve.hidden = true;  }

    // Sync spacer height with real banner height (handles responsive copy/buttons)
    var ro;
    function observeHeight() {
      if (!banner) return;
      if (typeof ResizeObserver === 'function') {
        ro = new ResizeObserver(function(entries) {
          var rect = entries[0] && entries[0].contentRect;
          if (rect && rect.height) {
            document.documentElement.style.setProperty('--cb-height', rect.height + 'px');
          }
        });
        ro.observe(banner);
      } else {
        // Fallback: one-time measure
        setTimeout(function(){
          var h = banner.getBoundingClientRect().height;
          if (h) document.documentElement.style.setProperty('--cb-height', h + 'px');
        }, 0);
      }
    }

    // Expose a reopen hook (footer “Manage cookies”)
    window.openCookieBanner = function() {
      show(); observeHeight();
    };

    // Initial state
    var choice = getChoice();
    if (choice === 'granted' || choice === 'denied') {
      // User has a prior choice → collapse both immediately
      hide();
    } else {
      // No choice yet → reserve space first, then show banner to avoid CLS
      if (reserve) reserve.hidden = false;
      show();
      observeHeight();
    }

    // Wire buttons
    if (accept) accept.addEventListener('click', function () {
      setChoice('granted'); updateConsent(true); hide();
      if (ro && ro.disconnect) ro.disconnect();
    }, { passive: true });

    if (decline) decline.addEventListener('click', function () {
      setChoice('denied'); updateConsent(false); hide();
      if (ro && ro.disconnect) ro.disconnect();
    }, { passive: true });
  })();
</script>
