---
// File: src/components/blog/compose/Pagination/index.astro

import css from "./Pagination.css?url";

export interface Props {
  basePath: string;   // e.g., "/blog" or "/blog/category/cv-tips"
  current: number;    // 1-based
  total: number;      // total pages ≥ 1
  /** Optional query to preserve across links (only sort, tag are kept). */
  query?: string | URLSearchParams | Record<string, string | number | null | undefined>;
}

const { basePath, current, total, query } = Astro.props as Props;

/* -------------------------- Query preservation -------------------------- */
function toSearchParams(q: Props["query"]): URLSearchParams {
  if (!q) return new URLSearchParams();
  if (typeof q === "string") return new URLSearchParams(q.startsWith("?") ? q.slice(1) : q);
  if (q instanceof URLSearchParams) return new URLSearchParams(q.toString());
  const usp = new URLSearchParams();
  for (const [k, v] of Object.entries(q)) {
    if (v === undefined || v === null || v === "") continue;
    usp.set(k, String(v));
  }
  return usp;
}

// Only keep params we support client-side: sort, tag
function filteredQueryString(q: Props["query"]): string {
  const src = toSearchParams(q);
  const out = new URLSearchParams();
  const sort = src.get("sort");
  const tag = src.get("tag");
  if (sort) out.set("sort", sort);
  if (tag) out.set("tag", tag);
  const s = out.toString();
  return s ? `?${s}` : "";
}

const qs = filteredQueryString(query);

/* ----------------------------- Href helpers ----------------------------- */
// Normalize base path to always end with "/" to satisfy trailingSlash: "always".
// Page 1 = `${base}/`
// Page N>1 = `${base}page/N/`
const base = basePath.endsWith("/") ? basePath : `${basePath}/`;
const hrefFor = (n: number) => {
  const path = n === 1 ? `${base}` : `${base}page/${n}/`;
  return `${path}${qs}`;
};

/* -------------------------------- State -------------------------------- */
const cur = Math.max(1, Math.min(current, Math.max(1, total)));

// Build windowed page list with gaps
const windowSize = 1; // pages on each side of current
const pages: (number | "...")[] = [];
const add = (x: number | "...") => pages.push(x);

if (total <= 7) {
  for (let i = 1; i <= total; i++) add(i);
} else {
  const start = Math.max(2, cur - windowSize);
  const end = Math.min(total - 1, cur + windowSize);

  add(1);
  if (start > 2) add("...");
  for (let i = start; i <= end; i++) add(i);
  if (end < total - 1) add("...");
  add(total);
}
---
<nav class="pagination" aria-label="Pagination" data-section="pagination">
  <link rel="stylesheet" href={css} />

  <div class="pagination__surface">
    <ol class="pagination__list" role="list">
      {/* Prev */}
      <li class="pagination__item">
        {cur > 1 ? (
          <a
            class="pagination__control"
            href={hrefFor(cur - 1)}
            rel="prev"
            data-cta="pagination-prev"
            aria-label={`Go to page ${cur - 1}`}
          >
            ‹ Prev
          </a>
        ) : (
          <span class="pagination__control is-disabled" aria-disabled="true">
            ‹ Prev
          </span>
        )}
      </li>

      {/* Numeric */}
      {pages.map((p) => (
        <li class="pagination__item">
          {p === "..." ? (
            <span class="pagination__gap" aria-hidden="true">…</span>
          ) : p === cur ? (
            <span
              class="pagination__page is-current"
              aria-current="page"
              aria-label={`Page ${p}, current`}
            >
              {p}
            </span>
          ) : (
            <a
              class="pagination__page"
              href={hrefFor(p as number)}
              data-cta="pagination-page"
              aria-label={`Go to page ${(p as number)}`}
            >
              {p}
            </a>
          )}
        </li>
      ))}

      {/* Next */}
      <li class="pagination__item">
        {cur < total ? (
          <a
            class="pagination__control"
            href={hrefFor(cur + 1)}
            rel="next"
            data-cta="pagination-next"
            aria-label={`Go to page ${cur + 1}`}
          >
            Next ›
          </a>
        ) : (
          <span class="pagination__control is-disabled" aria-disabled="true">
            Next ›
          </span>
        )}
      </li>
    </ol>
  </div>
</nav>
