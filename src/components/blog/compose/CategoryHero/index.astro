---
// File: src/components/blog/compose/CategoryHero/index.astro

import css from "./CategoryHero.css?url";

export interface Cta {
  href: string;
  label: string;
}

export interface Stats {
  postCount?: number;
  lastUpdated?: string | Date;
  readRange?: string; // e.g., "3â€“7 min"
}

export interface Props {
  title: string;
  dek?: string;
  stats?: Stats;
  primaryCta?: Cta;
  secondaryCta?: Cta;
  /** Fix Plan 158: avoid double horizontal gutters at page level */
  contained?: boolean;
}

const {
  title,
  dek,
  stats = {},
  primaryCta,
  secondaryCta,
  contained = false,
} = Astro.props as Props;

function fmtDate(d?: string | Date) {
  if (!d) return null;
  try {
    const date = typeof d === "string" ? new Date(d) : d;
    return date.toLocaleDateString("en-KE", {
      year: "numeric",
      month: "short",
    });
  } catch {
    return null;
  }
}

const lastUpdatedText = fmtDate(stats.lastUpdated);
const statBits = [
  typeof stats.postCount === "number" ? `${stats.postCount} posts` : null,
  lastUpdatedText ? `Updated ${lastUpdatedText}` : null,
  stats.readRange ? stats.readRange : null,
].filter(Boolean) as string[];

const dekId = "category-hero-dek";
const titleId = "category-hero-title";

/**
 * We always render a hero visual:
 * - If a <slot name="media" /> is provided, we use it.
 * - Otherwise we fall back to a default hero image in /public/images.
 */
const hasMediaSlot = Astro.slots.has?.("media") === true;
const hasMedia = true; // ensure layout treats hero as media-present
const FALLBACK_HERO = "/assets/images/blog/hero/blog-home-hero.webp"; // safe shared fallback
---

<section
  class="category-hero"
  data-section="category-hero"
  data-contained={String(contained)}
  data-has-media={String(hasMedia)}
  aria-labelledby={titleId}
>
  <link rel="stylesheet" href={css} />

  <div
    class:list={[
      "category-hero__grid",
      hasMedia ? "has-media" : "no-media",
      contained ? "is-contained" : "is-uncontained",
    ]}
  >
    <header class="category-hero__head">
      <p class="category-hero__eyebrow">Blog category</p>

      {/* h1 using global h1 styles via utility + hero-specific styling */}
      <h1 id={titleId} class="category-hero__title section-title h1">
        {title}
      </h1>

      {dek && (
        <p id={dekId} class="category-hero__dek">
          {dek}
        </p>
      )}

      {statBits.length > 0 && (
        <ul class="category-hero__stats" aria-label="Category metrics">
          {statBits.map((s) => (
            <li class="category-hero__stat">{s}</li>
          ))}
        </ul>
      )}

      {(primaryCta || secondaryCta) && (
        <div class="category-hero__ctas">
          {primaryCta && (
            <a
              class="btn btn-primary"
              href={primaryCta.href}
              data-cta="category-primary"
              aria-describedby={dek ? dekId : undefined}
            >
              {primaryCta.label}
            </a>
          )}
          {secondaryCta && (
            <a
              class="btn btn-accent"
              href={secondaryCta.href}
              data-cta="category-secondary"
              aria-describedby={dek ? dekId : undefined}
            >
              {secondaryCta.label}
            </a>
          )}
        </div>
      )}
    </header>

    <div class="category-hero__media" aria-hidden="true">
      {hasMediaSlot ? (
        <slot name="media" />
      ) : (
        <figure class="category-hero__media-frame">
          <div class="category-hero__media-backdrop" />
          <img
            src={FALLBACK_HERO}
            alt="Curated CV writing and career insights for this category"
            loading="lazy"
            decoding="async"
          />
        </figure>
      )}
    </div>
  </div>
</section>
