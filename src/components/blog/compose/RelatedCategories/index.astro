---
// src/components/blog/compose/RelatedCategories/index.astro

import sheet from "./RelatedCategories.css?url";
import type {
  RelatedCategoriesProps,
  RelatedInputItem,
  NormalisedRelatedItem,
} from "./types";

const {
  items = [],
  heading = "Related articles",
  categoryLabel,
} = Astro.props as RelatedCategoriesProps;

const safeItems = (items || []).filter(Boolean) as RelatedInputItem[];

const formatDate = (value?: string | Date): string | undefined => {
  if (!value) return undefined;
  const d = value instanceof Date ? value : new Date(value);
  if (Number.isNaN(d.getTime())) return undefined;
  return new Intl.DateTimeFormat("en-GB", {
    year: "numeric",
    month: "short",
    day: "2-digit",
  }).format(d);
};

const normalizeItem = (item: RelatedInputItem): NormalisedRelatedItem | null => {
  // Legacy shape: { data: { ... }, slug }
  if ("data" in item) {
    const data = item.data ?? {};
    const title = data.title as string | undefined;
    const category = data.category as string | undefined;
    const explicitUrl = (data as any).url as string | undefined;
    const slug = item.slug;

    const href =
      explicitUrl ??
      (category && slug ? `/blog/${category}/${slug}/` : undefined);

    if (!title || !href) return null;

    const dateVal = data.date as string | Date | undefined;
    const readingVal = data.readingTime as string | number | undefined;

    const dateLabel = formatDate(dateVal);
    const readingTimeLabel =
      typeof readingVal === "number"
        ? `${readingVal} min read`
        : readingVal || undefined;

    return {
      title,
      href,
      category,
      date: dateVal,
      readingTime: readingVal,
      cover: data.cover,
      dateLabel,
      readingTimeLabel,
    };
  }

  // Simple shape: { title, url, category, ... }
  const title = item.title;
  const href = item.url;
  if (!title || !href) return null;

  const dateVal = item.date;
  const readingVal = item.readingTime;

  const dateLabel = formatDate(dateVal);
  const readingTimeLabel =
    typeof readingVal === "number"
      ? `${readingVal} min read`
      : readingVal || undefined;

  return {
    title,
    href,
    category: item.category,
    date: dateVal,
    readingTime: readingVal,
    cover: item.cover,
    dateLabel,
    readingTimeLabel,
  };
};

const normalised: NormalisedRelatedItem[] = safeItems
  .map(normalizeItem)
  .filter(Boolean) as NormalisedRelatedItem[];

const hasItems = normalised.length > 0;
const headingText =
  categoryLabel && categoryLabel.trim().length > 0
    ? `More in ${categoryLabel}`
    : heading;
---
<link rel="stylesheet" href={sheet} />

{hasItems && (
  <section
    class="relatedPosts"
    aria-labelledby="related-posts-title"
    data-section="related-posts"
  >
    <h2 id="related-posts-title" class="relatedPosts__title h4">
      {headingText}
    </h2>

    <ul class="relatedPosts__list" aria-label="Related articles">
      {normalised.map((item) => (
        <li class="relatedPosts__item">
          <a href={item.href} class="relatedPosts__card">
            {item.cover?.src && (
              <div class="relatedPosts__media">
                <img
                  src={item.cover.src}
                  alt={item.cover.alt || ""}
                  loading="lazy"
                  decoding="async"
                />
              </div>
            )}

            {item.category && (
              <p class="relatedPosts__cat">
                {item.category}
              </p>
            )}

            <h3 class="relatedPosts__postTitle">
              {item.title}
            </h3>

            {(item.dateLabel || item.readingTimeLabel) && (
              <p class="relatedPosts__meta">
                {item.dateLabel && <span>{item.dateLabel}</span>}
                {item.dateLabel && item.readingTimeLabel && (
                  <span aria-hidden="true"> â€¢ </span>
                )}
                {item.readingTimeLabel && (
                  <span>{item.readingTimeLabel}</span>
                )}
              </p>
            )}
          </a>
        </li>
      ))}
    </ul>
  </section>
)}
