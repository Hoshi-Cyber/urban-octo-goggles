---
// src/components/blog/compose/PostCover/index.astro
// Fix Plan 190.2 / 193 / 195 – normalise cover prop (string path)
// and render a CLS-safe, responsive hero image card with AVIF/WebP support.

import css from "./PostCover.css?url";

interface CoverData {
  /** String path per Fix 195-C (e.g. "/assets/images/blog/<category>/<slug>-hero.webp") */
  src: string;
  alt?: string;
  width?: number;
  height?: number;
  caption?: string;
  credit?: string;
  /**
   * Optional responsive sources for modern formats.
   * Example: "/assets/...-480.avif 480w, /assets/...-768.avif 768w, /assets/...-1200.avif 1200w"
   */
  srcsetAvif?: string;
  srcsetWebp?: string;
  /**
   * Optional sizes attribute override.
   * Default: "(max-width: 768px) 100vw, 1200px"
   */
  sizes?: string;
}

interface PostCoverProps {
  cover: CoverData;
  /**
   * Optional post title, used as a fallback for alt text when cover.alt is missing.
   */
  title?: string;
}

const { cover, title = "" } = Astro.props as PostCoverProps;

// Normalised: treat cover.src strictly as a string path (Fix 195-D)
const imgSrc: string = typeof cover.src === "string" ? cover.src : "";

// Width/height are taken from cover; if missing, the browser will infer.
const imgWidth: number | undefined = cover.width;
const imgHeight: number | undefined = cover.height;

const imgAlt = cover.alt || title || "";
const hasCaption = Boolean(cover.caption || cover.credit);

// Responsive format sources and sizes
const srcsetAvif = cover.srcsetAvif;
const srcsetWebp = cover.srcsetWebp;
const sizesAttr = cover.sizes || "(max-width: 768px) 100vw, 1200px";
---
<link rel="stylesheet" href={css} />

{imgSrc && (
  <figure
    class="post__cover container"
    itemprop="image"
    itemscope
    itemtype="https://schema.org/ImageObject"
  >
    <picture>
      {srcsetAvif && (
        <source srcset={srcsetAvif} sizes={sizesAttr} type="image/avif" />
      )}
      {srcsetWebp && (
        <source srcset={srcsetWebp} sizes={sizesAttr} type="image/webp" />
      )}
      <img
        src={imgSrc}
        alt={imgAlt}
        width={imgWidth}
        height={imgHeight}
        loading="eager"
        decoding="async"
        fetchpriority="high"
        itemprop="url"
        sizes={sizesAttr}
      />
    </picture>

    {hasCaption && (
      <figcaption class="postCover__caption">
        {cover.caption && (
          <span class="postCover__captionText">{cover.caption}</span>
        )}
        {cover.credit && (
          <span class="postCover__credit">
            {cover.caption && <span aria-hidden="true"> · </span>}
            {cover.credit}
          </span>
        )}
      </figcaption>
    )}
  </figure>
)}
