---
import css from "./PostMeta.css?url";

type DateLike = string | Date;

interface PostMetaProps {
  date?: DateLike;
  updated?: DateLike;
  author?: string;
  authorUrl?: string;
  /**
   * Estimated reading time in whole minutes.
   * When <= 0 or not provided, it is omitted from the meta row.
   */
  readingTime?: number | null;
}

const { date, updated, author, authorUrl, readingTime } =
  Astro.props as PostMetaProps;

const toDate = (value?: DateLike) => {
  if (!value) return undefined;
  const d = value instanceof Date ? value : new Date(value);
  return Number.isNaN(d.getTime()) ? undefined : d;
};

const published = toDate(date);
const modified = toDate(updated);

const fmt = (d?: Date) =>
  d
    ? new Intl.DateTimeFormat("en-GB", {
        year: "numeric",
        month: "short",
        day: "2-digit",
      }).format(d)
    : null;

const iso = (d?: Date) => (d ? d.toISOString() : undefined);

const hasUpdated =
  published && modified
    ? modified.getTime() > published.getTime()
    : Boolean(modified);

const hasReadingTime =
  typeof readingTime === "number" &&
  Number.isFinite(readingTime) &&
  readingTime > 0;

const hasMeta = Boolean(published || hasUpdated || author || hasReadingTime);
---

<link rel="stylesheet" href={css} />

{hasMeta && (
  <dl class="post__meta" role="group" aria-label="Article metadata">
    {published && (
      <>
        <dt>Published</dt>
        <dd>
          <time datetime={iso(published)} itemprop="datePublished">
            {fmt(published)}
          </time>
        </dd>
      </>
    )}

    {hasUpdated && modified && (
      <>
        <dt>Updated</dt>
        <dd>
          <time datetime={iso(modified)} itemprop="dateModified">
            {fmt(modified)}
          </time>
        </dd>
      </>
    )}

    {author && (
      <>
        <dt>Author</dt>
        <dd itemprop="author" itemscope itemtype="https://schema.org/Person">
          {authorUrl ? (
            <a href={authorUrl} itemprop="url">
              <span itemprop="name">{author}</span>
            </a>
          ) : (
            <span itemprop="name">{author}</span>
          )}
        </dd>
      </>
    )}

    {hasReadingTime && (
      <>
        <dt>Reading time</dt>
        <dd>
          <span aria-label={`${readingTime} minute read`}>
            {readingTime} min read
          </span>
        </dd>
      </>
    )}
  </dl>
)}
