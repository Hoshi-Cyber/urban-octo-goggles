---
// File: src/components/blog/compose/CollectionSchema/index.astro
// Non-visual JSON-LD emitter for collection pages (e.g., blog categories).
// Keeps layout untouched while improving SEO and rich results.

import css from "./CollectionSchema.css?url";

/**
 * Collection page + items contracts
 */
export interface Crumb {
  name: string;
  url?: string;
}

export interface PageInfo {
  title: string;
  url: string;
  description?: string;
  totalItems?: number;
  page?: number;
  totalPages?: number;
  breadcrumb?: Crumb[];
}

export interface Item {
  title: string;
  url: string;
  image?: string;
  datePublished?: string;
  dateModified?: string;
  authorName?: string;
  description?: string;
}

export interface Props {
  pageInfo: PageInfo;
  items: Item[];
}

const { pageInfo, items } = Astro.props as Props;

/** Safe absolutizer: if Astro.site is set, make absolute; else return input as-is. */
const site = Astro.site ? Astro.site.toString() : "";
const abs = (u?: string | null): string | undefined =>
  u ? (site ? new URL(u, site).toString() : u) : undefined;

/** ItemList elements */
const listElements = items.map((it, index) => {
  const url = abs(it.url);
  const img = abs(it.image);

  return {
    "@type": "ListItem",
    position: index + 1,
    name: it.title,
    ...(url ? { url } : {}),
    ...(img ? { image: img } : {}),
  };
});

/** BreadcrumbList (optional) */
const breadcrumbLd =
  pageInfo.breadcrumb?.length
    ? {
        "@type": "BreadcrumbList",
        itemListElement: pageInfo.breadcrumb.map((crumb, index) => ({
          "@type": "ListItem",
          position: index + 1,
          name: crumb.name,
          ...(crumb.url ? { item: abs(crumb.url) } : {}),
        })),
      }
    : null;

/** CollectionPage schema */
const collectionPageLd = {
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  name: pageInfo.title,
  ...(pageInfo.description
    ? { description: pageInfo.description }
    : {}),
  ...(pageInfo.url ? { url: abs(pageInfo.url) } : {}),
  ...(breadcrumbLd ? { breadcrumb: breadcrumbLd } : {}),
  isPartOf: {
    "@type": "WebSite",
    name: (site && new URL(site).hostname) || "Website",
    ...(site ? { url: site } : {}),
  },
  ...(pageInfo.page && pageInfo.totalPages
    ? {
        pagination: {
          "@type": "CollectionPage",
          name: `Page ${pageInfo.page} of ${pageInfo.totalPages}`,
        },
      }
    : {}),
};

/** ItemList schema */
const itemListLd = {
  "@context": "https://schema.org",
  "@type": "ItemList",
  itemListOrder: "https://schema.org/ItemListOrderAscending",
  numberOfItems: pageInfo.totalItems ?? items.length,
  itemListElement: listElements,
};
---

<!-- Non-visual block that only injects SEO JSON-LD; kept fully hidden via CSS -->
<div class="collection-schema" aria-hidden="true">
  <link rel="stylesheet" href={css} />
  <script type="application/ld+json">
    {JSON.stringify(collectionPageLd)}
  </script>
  <script type="application/ld+json">
    {JSON.stringify(itemListLd)}
  </script>
</div>
