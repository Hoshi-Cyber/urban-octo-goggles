---
/* File: src/components/blog/base/BlogPost.astro
   Purpose: Adapter that maps legacy single-post props into BlogPostLayoutProps
   and appends legacy series/nav/related/lead-magnet/comments/author/inline-ad
   sections outside the new BlogPostLayout.

   FP-190 / FP-193 / FP-195 (legacy behaviour):
   - AuthorSlug-based author URL, series handling, conditional cover rendering,
     inline ad shell for CLS safety.

   FP-205.2 / 205.1.2 / 205.1.6 / 205.1.7:
   - Delegate core article layout (breadcrumbs, hero, cover, intro, TOC, body,
     IA slices, conversion blocks, relatedArticles) to BlogPostLayout.
   - Treat route-level heroImage, IA slices, and relatedArticles as canonical
     and fall back to legacy fields only for backwards compatibility.
   - Keep legacy outer blocks (tags/share, series, prev/next, RelatedCategories,
     lead magnet, comments, author card, inline ad shell) here.
*/

import "./BlogPost.css";

import PostTags from "@/components/blog/compose/PostTags/index.astro";
import PostShare from "@/components/blog/base/PostShare/index.astro";
import PostNav from "@/components/blog/compose/PostNav/index.astro";
import RelatedCategories from "@/components/blog/compose/RelatedCategories/index.astro";
import LeadMagnetStrip from "@/components/blog/compose/LeadMagnetStrip/index.astro";

import BlogPostLayout, {
  type BlogPostLayoutProps,
} from "@/components/blog/post/BlogPostLayout";

export interface SeriesItem {
  title: string;
  url: string;
  /**
   * Optional index for explicit ordering within the series.
   * Lower numbers appear earlier.
   */
  index?: number;
}

export interface Props {
  title: string;
  description?: string;
  category: string;
  tags: string[];
  date: Date;
  updated?: Date | null;
  readingTime?: number | null;
  author?: string;
  /** Normalized slug used to derive /about/editorial/<authorSlug>/ */
  authorSlug?: string;
  cover?: {
    /** String path per Fix 195-C (e.g. "/assets/images/blog/<category>/<slug>-hero.webp") */
    src: string;
    alt?: string;
    width?: number;
    height?: number;
    caption?: string;
    credit?: string;
    /** Optional advanced responsive sources provided via frontmatter */
    srcsetAvif?: string;
    srcsetWebp?: string;
    sizes?: string;
  };
  canonical?: string;
  tocHeadings?: Array<{ depth: number; slug: string; text: string }>;
  showTOC?: boolean;
  prev?: { data: any; slug: string } | null;
  next?: { data: any; slug: string } | null;
  related?: Array<{ data: any; slug: string }> | null;
  /**
   * Optional series definition for multi-part content.
   * When provided and non-empty, "In this series" navigation is rendered.
   */
  series?: SeriesItem[] | null;
  /**
   * Controls whether inline ad content is actually rendered
   * into the reserved ad shell. The shell footprint remains
   * present either way for CLS safety.
   */
  showInlineAd?: boolean;

  /**
   * New BlogPostLayoutProps-driven fields from Fix Plan 205.1 / 205.1.7.
   * Types are indexed from BlogPostLayoutProps to keep the adapter
   * exactly in sync with the layout contract.
   */
  heroTagline?: BlogPostLayoutProps["heroTagline"];
  heroSoftCta?: BlogPostLayoutProps["heroSoftCta"];
  heroImage?: BlogPostLayoutProps["heroImage"];
  introHtml?: BlogPostLayoutProps["introHtml"];
  keyTakeaways?: BlogPostLayoutProps["keyTakeaways"];
  inlineOffer?: BlogPostLayoutProps["inlineOffer"];
  socialProofItems?: BlogPostLayoutProps["socialProofItems"];
  faqItems?: BlogPostLayoutProps["faqItems"];
  finalCta?: BlogPostLayoutProps["finalCta"];
  checklist?: BlogPostLayoutProps["checklist"];
  relatedArticles?: BlogPostLayoutProps["relatedArticles"];
}

const {
  title,
  description,
  category,
  tags = [],
  date,
  updated = null,
  readingTime = null,
  author,
  authorSlug,
  cover,
  canonical,
  tocHeadings = [],
  showTOC = false,
  prev = null,
  next = null,
  related = null,
  series = null,
  showInlineAd = false,
  heroTagline,
  heroSoftCta,
  heroImage: heroImageFromRoute,
  introHtml,
  keyTakeaways,
  inlineOffer,
  socialProofItems,
  faqItems,
  finalCta,
  checklist,
  relatedArticles: relatedArticlesFromRoute,
} = Astro.props as Props;

const categoryUrl = `/blog/${category}/`;
const shareUrl = String(canonical || Astro.url);
const hasDescription =
  typeof description === "string" && description.trim().length > 0;

// Derive canonical author URL from normalized authorSlug (Fix 195-B)
const resolvedAuthorSlug = authorSlug ?? "mezame-editorial";
const authorUrl = `/about/editorial/${resolvedAuthorSlug}/`;

// Series handling: only render when defined and non-empty.
// Items with an explicit `index` are sorted ascending;
// items without `index` keep their original relative order and appear after.
const hasSeries = Array.isArray(series) && series.length > 0;

const sortedSeries: SeriesItem[] = hasSeries
  ? [...series!].sort((a, b) => {
      const ai = typeof a.index === "number" ? a.index : null;
      const bi = typeof b.index === "number" ? b.index : null;

      if (ai !== null && bi !== null) return ai - bi;
      if (ai !== null && bi === null) return -1;
      if (ai === null && bi !== null) return 1;
      return 0; // both null -> keep relative order in stable sort
    })
  : [];

// Conditional cover rendering: only when a non-empty src is present (Fix 195-D)
const hasCover =
  !!cover &&
  typeof cover.src === "string" &&
  cover.src.trim().length > 0;

// Map legacy tocHeadings into BlogPostLayout TOC items
const toc =
  tocHeadings && tocHeadings.length > 0
    ? tocHeadings.map((h) => ({
        id: h.slug,
        label: h.text,
        level: h.depth,
        href: `#${h.slug}`,
      }))
    : undefined;

// Legacy related[] → RelatedArticle[] fallback mapping (205.1.6).
// Canonical relatedArticles[] should be computed in the route via
// src/lib/blog/related; this exists purely for backwards compatibility.
const legacyRelatedArticles: BlogPostLayoutProps["relatedArticles"] =
  related && related.length > 0
    ? related.map((item) => {
        const slug = item.slug;
        const rawCategory = item.data?.category ?? category;
        const categorySlug =
          typeof rawCategory === "string" && rawCategory.trim().length > 0
            ? rawCategory
            : undefined;

        const baseSlug =
          typeof slug === "string" && slug.includes("/")
            ? slug.split("/").pop()!
            : slug;

        const href =
          categorySlug != null
            ? `/blog/${categorySlug}/${baseSlug}/`
            : `/blog/${baseSlug}/`;

        const readingTimeMinutes =
          typeof item.data?.readingTime === "number"
            ? item.data.readingTime
            : undefined;

        const dateISO =
          item.data?.date != null
            ? new Date(item.data.date).toISOString()
            : undefined;

        return {
          title: item.data?.title ?? baseSlug,
          href,
          category: categorySlug ?? category,
          readingTimeMinutes,
          excerpt: item.data?.description ?? undefined,
          dateISO,
        };
      })
    : undefined;

const hasRouteRelated =
  Array.isArray(relatedArticlesFromRoute) &&
  relatedArticlesFromRoute.length > 0;

const resolvedRelatedArticles: BlogPostLayoutProps["relatedArticles"] =
  hasRouteRelated ? relatedArticlesFromRoute : legacyRelatedArticles;

// Resolve heroImage: prefer route/frontmatter-mapped heroImage,
// fall back to legacy cover → hero mapping.
const heroImage: BlogPostLayoutProps["heroImage"] =
  heroImageFromRoute ??
  (hasCover
    ? {
        src: cover!.src,
        alt: cover!.alt ?? title,
        width: cover!.width,
        height: cover!.height,
      }
    : undefined);

// Build props for BlogPostLayout (205.2 adapter layer)
const blogPostLayoutProps: BlogPostLayoutProps = {
  breadcrumbs: [
    { label: "Home", href: "/" },
    { label: "Blog", href: "/blog/" },
    { label: category, href: categoryUrl },
    { label: title, href: Astro.url.pathname },
  ],
  category,
  title,
  heroTagline,
  heroSoftCta,
  publishedAt: date?.toISOString?.() ?? undefined,
  updatedAt:
    updated && updated instanceof Date ? updated.toISOString() : undefined,
  readingTimeMinutes:
    typeof readingTime === "number" ? readingTime : undefined,
  authorName: author,
  authorUrl,
  heroImage,
  introHtml,
  keyTakeaways,
  inlineOffer,
  socialProofItems,
  faqItems,
  finalCta,
  checklist,
  toc,
  showToc: showTOC && !!toc && toc.length > 0,
  relatedArticles: resolvedRelatedArticles,
};
---

<!--
  FP-205.2: This component is now a thin adapter.
  BlogPostLayout handles the core article IA (breadcrumbs, hero, cover, intro,
  TOC, body, IA blocks, conversion, related).
  This wrapper keeps legacy footer/meta/series/nav/related/lead-magnet/comments/
  author/ad sections for backwards compatibility.
-->
<div class="post stack stack--first-tight page-gap-after">
  <BlogPostLayout {...blogPostLayoutProps}>
    <slot />
  </BlogPostLayout>

  <!-- Legacy footer: tags + share (kept for now outside BlogPostLayout) -->
  <footer class="post__footer container">
    {tags.length > 0 && <PostTags tags={tags} />}
    <PostShare title={title} url={shareUrl} />
  </footer>

  <!-- Series / nav / related posts (block) -->
  {hasSeries && sortedSeries.length > 0 && (
    <section
      class="post__series container"
      aria-labelledby="post-series-title"
    >
      <h2 id="post-series-title" class="h4">
        In this series
      </h2>

      <ol>
        {sortedSeries.map((item) => (
          <li>
            <a href={item.url}>{item.title}</a>
          </li>
        ))}
      </ol>
    </section>
  )}

  <nav class="post__nav container" aria-label="Post navigation">
    <PostNav {prev} {next} />
  </nav>

  {related && related.length > 0 && (
    <section class="post__related container">
      <RelatedCategories items={related} />
    </section>
  )}

  <!-- Lead magnet strip (compose) -->
  <section class="post__leadmagnet container">
    <LeadMagnetStrip />
  </section>

  <!-- Comments (deferred slot) -->
  <section class="post__comments container" aria-label="Comments">
    <slot name="comments" />
  </section>

  <!-- Author card container (named slot, placed after footer stack) -->
  <section class="post__author container" aria-label="Article author">
    <slot name="author" />
  </section>

  <!-- Inline ad shell (optional, CLS-controlled; kept outside required footer order) -->
  <section
    class="ad-slot container"
    role="complementary"
    aria-label="Sponsored"
    data-inline-ad-shell
    hidden={!showInlineAd}
  >
    <div
      class="ad-box"
      data-inline-ad-active={showInlineAd ? "true" : "false"}
    >
      {showInlineAd && <slot name="inline-ad" />}
    </div>
  </section>
</div>
