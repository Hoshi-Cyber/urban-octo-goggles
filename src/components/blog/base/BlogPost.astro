---
/* File: src/components/blog/base/BlogPost.astro
   Purpose: Orchestrate compose components for single-post layout.
   FP-190: Use Breadcrumbs + PostHeader/Meta/Cover/TOC/Tags/Share/Nav/Related/LeadMagnet.
*/
import type { ImageMetadata } from "astro";
import "./BlogPost.css";

import Breadcrumbs from "@/components/blog/base/Breadcrumbs/index.astro";

import PostHeader from "@/components/blog/compose/PostHeader/index.astro";
import PostMeta from "@/components/blog/compose/PostMeta/index.astro";
import PostCover from "@/components/blog/compose/PostCover/index.astro";
import PostToc from "@/components/blog/compose/PostToc/index.astro";
import PostTags from "@/components/blog/compose/PostTags/index.astro";
import PostShare from "@/components/blog/base/PostShare/index.astro";
import PostNav from "@/components/blog/compose/PostNav/index.astro";
import RelatedCategories from "@/components/blog/compose/RelatedCategories/index.astro";
import LeadMagnetStrip from "@/components/blog/compose/LeadMagnetStrip/index.astro";

export interface SeriesItem {
  title: string;
  url: string;
  /**
   * Optional index for explicit ordering within the series.
   * Lower numbers appear earlier.
   */
  index?: number;
}

export interface Props {
  title: string;
  description?: string;
  category: string;
  tags: string[];
  date: Date;
  updated?: Date | null;
  readingTime?: number | null;
  cover?: {
    src: ImageMetadata | string;
    alt?: string;
    width?: number;
    height?: number;
    caption?: string;
    /** Optional advanced responsive sources provided via frontmatter */
    srcsetAvif?: string;
    srcsetWebp?: string;
    sizes?: string;
  };
  canonical?: string;
  tocHeadings?: Array<{ depth: number; slug: string; text: string }>;
  showTOC?: boolean;
  prev?: { data: any; slug: string } | null;
  next?: { data: any; slug: string } | null;
  related?: Array<{ data: any; slug: string }> | null;
  /**
   * Optional series definition for multi-part content.
   * When provided and non-empty, "In this series" navigation is rendered.
   */
  series?: SeriesItem[] | null;
  /**
   * Controls whether inline ad content is actually rendered
   * into the reserved ad shell. The shell footprint remains
   * present either way for CLS safety.
   */
  showInlineAd?: boolean;
}

const {
  title,
  description,
  category,
  tags = [],
  date,
  updated = null,
  readingTime = null,
  cover,
  canonical,
  tocHeadings = [],
  showTOC = false,
  prev = null,
  next = null,
  related = null,
  series = null,
  showInlineAd = false,
} = Astro.props as Props;

const categoryUrl = `/blog/${category}/`;
const shareUrl = String(canonical || Astro.url);
const hasDescription =
  typeof description === "string" && description.trim().length > 0;

// Series handling: only render when defined and non-empty.
// Items with an explicit `index` are sorted ascending;
// items without `index` keep their original relative order and appear after.
const hasSeries = Array.isArray(series) && series.length > 0;

const sortedSeries: SeriesItem[] = hasSeries
  ? [...series!].sort((a, b) => {
      const ai = typeof a.index === "number" ? a.index : null;
      const bi = typeof b.index === "number" ? b.index : null;

      if (ai !== null && bi !== null) return ai - bi;
      if (ai !== null && bi === null) return -1;
      if (ai === null && bi !== null) return 1;
      return 0; // both null -> keep relative order in stable sort
    })
  : [];
---

<!-- Pure article; wrapped by <BaseLayout> at route level -->
<article
  id="post-main"
  class="post stack stack--first-tight page-gap-after"
  role="article"
  aria-labelledby="post-title"
  itemscope
  itemtype="https://schema.org/Article"
>
  <!-- 0) Breadcrumbs (global blog breadcrumb system) -->
  <section class="post__breadcrumbs container" aria-label="Breadcrumb">
    <Breadcrumbs
      items={[
        { label: "Home", href: "/" },
        { label: "Blog", href: "/blog/" },
        { label: category, href: categoryUrl },
        { label: title, current: true },
      ]}
    />
  </section>

  <!-- 1) Header (eyebrow + H1) -->
  <PostHeader id="post-title" {category} {title} categoryUrl={categoryUrl} />

  <!-- 2) Meta row (date, reading time, updated) -->
  <PostMeta {date} {readingTime} {updated} />

  <!-- 3) Cover image (CLS-safe) -->
  {cover && <PostCover {cover} />}

  <!-- 4) Lead paragraph (optional introduction) -->
  {hasDescription && (
    <div class="post__lead container">
      <p class="page-lead" itemprop="description">
        {description}
      </p>
    </div>
  )}

  <!-- 5) TOC (compose component) -->
  {showTOC && (
    <div class="container">
      <PostToc headings={tocHeadings} />
    </div>
  )}

  <!-- 6) Article body (MDX content injected via default slot) -->
  <section
    class="post__body"
    aria-label="Article content"
    itemprop="articleBody"
  >
    <div class="container">
      <div class="prose">
        <slot />
      </div>
    </div>
  </section>

  <!-- 7) Series navigation (optional) -->
  {hasSeries && sortedSeries.length > 0 && (
    <section
      class="post__series container"
      aria-labelledby="post-series-title"
    >
      <h2 id="post-series-title" class="h4">
        In this series
      </h2>

      <ol>
        {sortedSeries.map((item) => (
          <li>
            <a href={item.url}>{item.title}</a>
          </li>
        ))}
      </ol>
    </section>
  )}

  <!-- 8) Author card container (named slot) -->
  <section class="post__author container" aria-label="Article author">
    <slot name="author" />
  </section>

  <!-- 9) Footer: tags + share -->
  <footer class="post__footer container">
    {tags.length > 0 && <PostTags tags={tags} />}
    <PostShare title={title} url={shareUrl} />
  </footer>

  <!-- 10) Prev/Next navigation -->
  <nav class="post__nav container" aria-label="Post navigation">
    <PostNav {prev} {next} />
  </nav>

  <!-- 11) Inline ad shell (optional, CLS-controlled) -->
  <section
    class="ad-slot container"
    role="complementary"
    aria-label="Sponsored"
    data-inline-ad-shell
    hidden={!showInlineAd}
  >
    <div
      class="ad-box"
      data-inline-ad-active={showInlineAd ? "true" : "false"}
    >
      {showInlineAd && <slot name="inline-ad" />}
    </div>
  </section>

  <!-- 12) Related posts -->
  {related && related.length > 0 && (
    <section class="post__related container">
      <RelatedCategories items={related} />
    </section>
  )}

  <!-- 13) Lead magnet strip (compose) -->
  <section class="post__leadmagnet container">
    <LeadMagnetStrip />
  </section>

  <!-- 14) Comments (deferred slot) -->
  <section class="post__comments container" aria-label="Comments">
    <slot name="comments" />
  </section>
</article>
