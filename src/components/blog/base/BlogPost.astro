---
/* File: src/components/blog/base/BlogPost.astro
   Purpose: Thin adapter that maps route-level single-post props into
   BlogPostLayoutProps and delegates ALL visible IA to BlogPostLayout.

   Legacy behaviour note:
   - Older versions appended tags/share, series, prev/next, legacy related,
     lead magnet, comments, author card, and inline ad shells after the
     core article layout.
   - Under Fix Plan 205.2 + 213, those legacy outer blocks are now retired
     so that the single source of truth for the page IA lives inside
     BlogPostLayout only.
*/

import "./BlogPost.css";

import BlogPostLayout, {
  type BlogPostLayoutProps,
} from "@/components/blog/post/BlogPostLayout";

export interface SeriesItem {
  title: string;
  url: string;
  /**
   * Optional index for explicit ordering within the series.
   * Lower numbers appear earlier.
   */
  index?: number;
}

export interface Props {
  title: string;
  description?: string;
  category: string;
  tags: string[];
  date: Date;
  updated?: Date | null;
  readingTime?: number | null;
  author?: string;
  /** Normalized slug used to derive /about/editorial/<authorSlug>/ */
  authorSlug?: string;
  cover?: {
    /** String path per Fix 195-C (e.g. "/images/blog/<category>/<slug>-hero.webp") */
    src: string | { src: string; width?: number; height?: number };
    alt?: string;
    width?: number;
    height?: number;
    caption?: string;
    credit?: string;
    /** Optional advanced responsive sources provided via frontmatter */
    srcsetAvif?: string;
    srcsetWebp?: string;
    sizes?: string;
  };
  canonical?: string;
  tocHeadings?: Array<{ depth: number; slug: string; text: string }>;
  showTOC?: boolean;
  prev?: { data: any; slug: string } | null;
  next?: { data: any; slug: string } | null;
  related?: Array<{ data: any; slug: string }> | null;
  /**
   * Optional series definition for multi-part content.
   * Kept in the props for backwards compatibility, but no longer rendered.
   */
  series?: SeriesItem[] | null;
  /**
   * Controls whether inline ad content is actually rendered
   * into the reserved ad shell. Retained for type compatibility only.
   */
  showInlineAd?: boolean;

  /**
   * New BlogPostLayoutProps-driven fields from Fix Plan 205.1 / 205.1.7.
   * Types are indexed from BlogPostLayoutProps to keep the adapter
   * exactly in sync with the layout contract.
   */
  heroTagline?: BlogPostLayoutProps["heroTagline"];
  heroSoftCta?: BlogPostLayoutProps["heroSoftCta"];
  heroImage?: BlogPostLayoutProps["heroImage"] | string;
  introHtml?: BlogPostLayoutProps["introHtml"];
  keyTakeaways?: BlogPostLayoutProps["keyTakeaways"];
  inlineOffer?: BlogPostLayoutProps["inlineOffer"];
  socialProofItems?: BlogPostLayoutProps["socialProofItems"];
  faqItems?: BlogPostLayoutProps["faqItems"];
  finalCta?: BlogPostLayoutProps["finalCta"];
  checklist?: BlogPostLayoutProps["checklist"];
  relatedArticles?: BlogPostLayoutProps["relatedArticles"];

  /**
   * Fix Plan 004 – layoutPreset frontmatter bridge:
   * - Optional per-article override for the article layout preset.
   * - When provided, it overrides the category-derived default.
   * - Mapped directly into BlogPostLayoutProps.preset.
   *
   * Available values (BlogPostLayoutPresetKey):
   * - "conversionArticle"
   * - "editorialArticle"
   * - "analysisArticle"
   * - "shortInsight"
   * - "campaignLanding"
   */
  layoutPreset?: BlogPostLayoutProps["preset"];
}

const {
  title,
  description,
  category,
  // tags = [],        // no longer rendered, but kept in props for future use
  date,
  updated = null,
  readingTime = null,
  author,
  authorSlug,
  cover,
  canonical,
  tocHeadings = [],
  showTOC = false,
  // prev = null,      // legacy nav – retired from output
  // next = null,
  // related = null,   // legacy related – retired in favour of layout-level relatedArticles
  // series = null,
  // showInlineAd = false,
  heroTagline,
  heroSoftCta,
  heroImage: heroImageFromRoute,
  introHtml,
  keyTakeaways,
  inlineOffer,
  socialProofItems,
  faqItems,
  finalCta,
  checklist,
  relatedArticles: relatedArticlesFromRoute,
  layoutPreset,
} = Astro.props as Props;

const categoryUrl = `/blog/${category}/`;
const shareUrl = String(canonical || Astro.url); // kept for potential future use

// Derive canonical author URL from normalized authorSlug (Fix 195-B)
const resolvedAuthorSlug = authorSlug ?? "mezame-editorial";
const authorUrl = `/about/editorial/${resolvedAuthorSlug}/`;

// Map legacy tocHeadings into BlogPostLayout TOC items
const toc =
  tocHeadings && tocHeadings.length > 0
    ? tocHeadings.map((h) => ({
        id: h.slug,
        label: h.text,
        level: h.depth,
        href: `#${h.slug}`,
      }))
    : undefined;

/**
 * Normalise hero image input (string | object | Astro image object) into the
 * single shape expected by BlogPostLayout, or undefined when not available.
 *
 * This prevents runtime errors like "Cannot read properties of undefined (reading 'src')"
 * when heroImage / cover are missing or in different formats.
 */
type HeroInput =
  | string
  | {
      src?: any;
      alt?: string;
      width?: number;
      height?: number;
    }
  | null
  | undefined;

function normaliseHeroImage(
  input: HeroInput,
  fallbackAlt: string,
): BlogPostLayoutProps["heroImage"] | undefined {
  if (!input) return undefined;

  // Case 1: plain string path, e.g. "/assets/images/blog/hero/blog-home-hero-02.webp"
  if (typeof input === "string") {
    return {
      src: input,
      alt: fallbackAlt,
    };
  }

  // Case 2: object with src (string or Astro image object)
  const srcVal = input.src;
  if (!srcVal) return undefined;

  // 2a: src is already a string path
  if (typeof srcVal === "string") {
    return {
      src: srcVal,
      alt: input.alt ?? fallbackAlt,
      width: input.width,
      height: input.height,
    };
  }

  // 2b: src is an Astro image object with its own src/width/height
  return {
    src: srcVal.src,
    alt: input.alt ?? fallbackAlt,
    width: srcVal.width ?? input.width,
    height: srcVal.height ?? input.height,
  };
}

// Resolve heroImage: prefer route/frontmatter-mapped heroImage,
// then fall back to legacy cover mapping.
// Both heroImageFromRoute and cover may contain string paths or Astro images.
const heroImage: BlogPostLayoutProps["heroImage"] =
  normaliseHeroImage(heroImageFromRoute as HeroInput, title) ??
  normaliseHeroImage(cover as HeroInput, title);

// relatedArticles are now expected from route (via src/lib/blog/related)
const resolvedRelatedArticles: BlogPostLayoutProps["relatedArticles"] =
  Array.isArray(relatedArticlesFromRoute) &&
  relatedArticlesFromRoute.length > 0
    ? relatedArticlesFromRoute
    : undefined;

/**
 * Fix Plan 004 – Step 3: preset inference and wiring
 *
 * - Derive a sensible default preset based on category:
 *     • "cv-tips" or "linkedin"     → "conversionArticle"
 *     • "kenya-market"              → "analysisArticle"
 *     • everything else (e.g. career-growth) → "editorialArticle"
 *
 * - Allow per-article override via layoutPreset (frontmatter):
 *     • When layoutPreset is present, it wins.
 *     • Otherwise, fall back to the category-derived default.
 *
 * - Pass the resolved preset into BlogPostLayout so that the layout
 *   can use the PRESET_SLICES registry to decide slice ordering.
 */
const fmPreset = layoutPreset;

const defaultPresetForCategory: BlogPostLayoutProps["preset"] =
  category === "cv-tips" || category === "linkedin"
    ? "conversionArticle"
    : category === "kenya-market"
    ? "analysisArticle"
    : "editorialArticle";

const resolvedPreset: BlogPostLayoutProps["preset"] =
  fmPreset ?? defaultPresetForCategory;

// Build props for BlogPostLayout (205.2 adapter layer)
const blogPostLayoutProps: BlogPostLayoutProps = {
  breadcrumbs: [
    { label: "Home", href: "/" },
    { label: "Blog", href: "/blog/" },
    { label: category, href: categoryUrl },
    { label: title, href: Astro.url.pathname },
  ],
  category,
  title,
  heroTagline,
  heroSoftCta,
  publishedAt: date?.toISOString?.() ?? undefined,
  updatedAt:
    updated && updated instanceof Date ? updated.toISOString() : undefined,
  readingTimeMinutes:
    typeof readingTime === "number" ? readingTime : undefined,
  authorName: author,
  authorUrl,
  heroImage,
  introHtml,
  keyTakeaways,
  inlineOffer,
  socialProofItems,
  faqItems,
  finalCta,
  checklist,
  toc,
  showToc: showTOC && !!toc && toc.length > 0,
  relatedArticles: resolvedRelatedArticles,
  preset: resolvedPreset,
};
---

<!--
  Under Fix Plan 213 + Fix Plan 004, BlogPostLayout owns the full
  single-article IA (hero, intro, TOC, body, conversion slices, related, etc),
  including layout presets and slice ordering.
  This wrapper is intentionally minimal and does not append any legacy
  footer / nav / related / comments / author / ad shells.
-->
<div class="post stack stack--first-tight page-gap-after">
  <BlogPostLayout {...blogPostLayoutProps}>
    <slot />
  </BlogPostLayout>
</div>
