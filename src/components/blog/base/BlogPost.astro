---
// src/components/blog/base/BlogPost.astro
import BaseLayout from "../../layout/BaseLayout.astro";

// Blog components
import PostHeader from "../compose/PostHeader/index.astro";
import PostMeta from "../compose/PostMeta/index.astro";
import PostTags from "../compose/PostTags/index.astro";
import PostCover from "../compose/PostCover/index.astro";
import PostCTAs from "../compose/PostCTAs/index.astro";
import LeadMagnetStrip from "../compose/LeadMagnetStrip/index.astro"; // end-of-article conversion strip

// UI
import Badge from "../../ui/Badge/index.astro";

// FP-172: bundle CSS instead of head <link> URLs
import "./BlogPost.css";
import "../../../styles/prose.css";

export interface Cover {
  src: string;
  alt?: string;
  width?: number;
  height?: number;
}
export interface SEO {
  canonical?: string;
  title?: string;
  description?: string;
  [key: string]: any;
}
export interface CTA {
  label: string;
  url: string;
}
export interface PrevNext {
  title: string;
  url: string;
}
export interface Props {
  title: string;
  description?: string;
  seo?: SEO;
  canonical?: string;      // may arrive from MD frontmatter
  ogImage?: string;
  date?: string | Date;
  updated?: string | Date;
  author?: string;
  readingTime?: number;
  readingTimeMinutes?: number; // alias
  tags?: string[];
  cover?: Cover | null;
  ctaPrimary?: CTA;
  ctaSecondary?: CTA;

  // optional breadcrumb inputs
  category?: string;
  categoryUrl?: string;

  // adjacent navigation
  prev?: PrevNext | null;
  next?: PrevNext | null;
}

const props = Astro.props as Props;

const {
  title,
  description = "",
  author,
  tags = [],
  ctaPrimary,
  ctaSecondary,
  category,
  categoryUrl,
  prev = null,
  next = null,
} = props;

// reading time normalization
const readingTime =
  typeof props.readingTime === "number"
    ? props.readingTime
    : typeof props.readingTimeMinutes === "number"
    ? props.readingTimeMinutes
    : undefined;

// dates
const publishedDate = props.date ? new Date(props.date) : null;
const updatedDate = props.updated ? new Date(props.updated) : publishedDate;

const isoPublished = publishedDate ? publishedDate.toISOString() : null;
const isoModified = updatedDate ? updatedDate.toISOString() : null;

const tagList = (tags || []).slice(0, 12);

// canonical
const siteUrl = Astro.site?.toString().replace(/\/$/, "") || "";
const seoIn = props.seo ?? {};
const fmCanonical = props.canonical;
const canonicalSrc = (seoIn as any).canonical ?? fmCanonical ?? Astro.url.pathname;
const canonical =
  canonicalSrc && canonicalSrc.startsWith("http") ? canonicalSrc : `${siteUrl}${canonicalSrc ?? ""}`;

// cover inference
let cover: Cover | null = props.cover ?? null;
if (!cover && typeof props.ogImage === "string" && props.ogImage.trim()) {
  cover = { src: props.ogImage.trim(), alt: title };
}

// JSON-LD (Article)
const jsonLd = {
  "@context": "https://schema.org",
  "@type": "Article",
  headline: title,
  datePublished: isoPublished || undefined,
  dateModified: isoModified || undefined,
  author: author ? [{ "@type": "Person", name: author }] : undefined,
  image: cover?.src ? (cover.src.startsWith("http") ? cover.src : `${siteUrl}${cover.src}`) : undefined,
  mainEntityOfPage: canonical,
  description: description || (seoIn as any)?.description,
  publisher: { "@type": "Organization", name: "CV Writing Kenya" }
};

// helpers
const showUpdatedBadge =
  publishedDate && updatedDate && updatedDate.getTime() > publishedDate.getTime();

// breadcrumbs (UI + JSON-LD)
const crumbs = [
  { label: "Blog", href: "/blog" },
  ...(category
    ? [{
        label: category,
        href: categoryUrl && categoryUrl.startsWith("/")
          ? categoryUrl
          : `/blog/category/${encodeURIComponent(category!.toLowerCase())}`
      }]
    : []),
  { label: title, href: canonical }
];

const breadcrumbJsonLd = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  itemListElement: crumbs.map((c, i) => ({
    "@type": "ListItem",
    position: i + 1,
    name: c.label,
    item: c.href.startsWith("http") ? c.href : `${siteUrl}${c.href}`
  }))
};

// slot checks
const hasToc = Astro.slots.has("toc");
const hasRelated = Astro.slots.has("related");
---
<BaseLayout title={title} description={description} seo={{ ...seoIn, canonical }}>
  {/* Head: JSON-LD only; CSS is bundled via imports (FP-172) */}
  <fragment slot="head">
    <script type="application/ld+json">{JSON.stringify(jsonLd)}</script>
    <script type="application/ld+json">{JSON.stringify(breadcrumbJsonLd)}</script>
  </fragment>

  <article class="post container" itemscope itemtype="https://schema.org/Article">
    {/* Breadcrumbs */}
    <nav class="post__breadcrumbs" aria-label="Breadcrumb">
      <ol>
        {crumbs.slice(0, -1).map((c) => (
          <li><a href={c.href}>{c.label}</a></li>
        ))}
        <li aria-current="page">{crumbs[crumbs.length - 1].label}</li>
      </ol>
    </nav>

    {/* Header */}
    <PostHeader title={title} eyebrow="Blog" />

    {showUpdatedBadge && (
      <p class="post__updated">
        <Badge title="Content updated">
          Updated {new Intl.DateTimeFormat("en-GB", { year: "numeric", month: "long", day: "numeric" }).format(updatedDate!)}
        </Badge>
      </p>
    )}

    <PostMeta
      date={publishedDate ?? undefined}
      updated={updatedDate ?? undefined}
      author={author}
      readingTime={typeof readingTime === "number" && readingTime > 0 ? readingTime : undefined}
    />

    {tagList.length > 0 && <PostTags tags={tagList} variant="header" />}

    {/* Cover image — wrapped for CSS targeting (FP-172) */}
    {cover?.src && (
      <figure class="post__cover">
        <PostCover
          src={cover.src}
          alt={cover.alt ?? ""}
          width={cover.width ?? 1280}
          height={cover.height ?? 720}
        />
      </figure>
    )}

    {/* Lead paragraph */}
    {description && (
      <p class="post__lead">{description}</p>
    )}

    {/* Optional Table of Contents */}
    {hasToc && (
      <aside class="post__toc" aria-label="Table of contents">
        <slot name="toc" />
      </aside>
    )}

    {/* Inline CTAs */}
    {(ctaPrimary || ctaSecondary) && (
      <PostCTAs
        primary={ctaPrimary ? { label: ctaPrimary.label, url: ctaPrimary.url } : undefined}
        secondary={ctaSecondary ? { label: ctaSecondary.label, url: ctaSecondary.url } : undefined}
      />
    )}

    {/* Article body */}
    <section class="post__content prose" itemprop="articleBody">
      <slot />
    </section>

    {/* Author card */}
    {author && (
      <section class="post__author" aria-labelledby="about-author">
        <h3 id="about-author">About the author</h3>
        <p>{author}</p>
      </section>
    )}

    {/* Next/Prev navigation */}
    {(prev || next) && (
      <nav class="post__nav" aria-label="Post navigation">
        {prev && <a class="post__navLink post__navPrev" href={prev.url}>← {prev.title}</a>}
        {next && <a class="post__navLink post__navNext" href={next.url}>{next.title} →</a>}
      </nav>
    )}

    {/* Related posts */}
    {hasRelated && (
      <section class="post__related" aria-labelledby="related-articles">
        <h3 id="related-articles">Related articles</h3>
        <slot name="related" />
      </section>
    )}

    {/* Footer tags */}
    {tagList.length > 0 && (
      <footer class="post__footer">
        <PostTags tags={tagList} variant="footer" />
      </footer>
    )}

    {/* LeadMagnetStrip at the end (deferred) */}
    <section class="post__leadmagnet">
      <LeadMagnetStrip />
    </section>
  </article>
</BaseLayout>
