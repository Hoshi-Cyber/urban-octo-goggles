---
/* File: src/components/blog/post/BlogPostLayout/index.astro
 *
 * Purpose:
 * - Render the full single blog post layout for CVWriting.co.ke.
 * - All data is provided via BlogPostLayoutProps from the route layer.
 *
 * Fix Plan 205.1:
 * - Single source of truth for hero, intro, keyTakeaways, inlineOffer, socialProof,
 *   FAQ, finalCta, checklist, and relatedArticles.
 *
 * Fix Plan 205.1.7:
 * - socialProofItems, faqItems, and checklist are now fed via central data banks
 *   (src/data/testimonials, src/data/faqs, src/data/checklists) resolved in the
 *   route; this layout is purely presentational.
 *
 * Fix Plan 205.2:
 * - Consolidate all core single-article IA into this layout.
 * - BlogPost.astro acts as a thin adapter; routes construct BlogPostLayoutProps.
 * - This component owns structure only and does not perform any data fetching.
 *
 * Fix Plan 213:
 * - Introduce explicit IA presets and slice ordering for optional bands.
 * - Keep header as a fixed shell; render remaining bands via ordered slice keys.
 * - Clarify KeyTakeaways vs Checklist:
 *   • KeyTakeaways → compact summary at top of body column (“what this post says”).
 *   • Checklist   → implementation band (“what to do next”) via ChecklistSection.
 *
 * Fix Plan 213.3 – separation contract (summary vs implementation):
 * - KeyTakeaways: short, insight-focused summary bullets (no verb-first “to-dos”).
 * - Checklist: ordered, verb-first implementation steps (action list only).
 *
 * Fix Plan 004 (Article Layout Presets v1.0) + FP005-09:
 * - Accept a layout preset key and resolve slice ordering from a preset registry.
 * - Guard preset against invalid values; fall back to "conversionArticle".
 */

import type { AstroComponentFactory } from "astro";

import Breadcrumbs from "@/components/blog/base/Breadcrumbs";
import PostToc from "@/components/blog/compose/PostToc";
import PostCover from "@/components/blog/compose/PostCover";
import FAQAccordion from "@/components/faq/FAQAccordion";

import ArticleHero from "@/components/blog/post/ArticleHero";
import IntroBlock from "@/components/blog/post/IntroBlock";
import KeyTakeaways from "@/components/blog/post/KeyTakeaways";
import InlineOfferBlock from "@/components/blog/post/InlineOfferBlock";
import SocialProofStrip from "@/components/blog/post/SocialProofStrip";
import FinalCtaBlock from "@/components/blog/post/FinalCtaBlock";
import RelatedArticles from "@/components/blog/post/RelatedArticles";
import ChecklistSection from "@/components/blog/post/ChecklistSection";

import "./BlogPostLayout.css";

type BreadcrumbItem = {
  href: string;
  label: string;
};

type TocItem = {
  id: string;
  label: string;
  level: number;
  href?: string;
};

type HeroImage = {
  src: string;
  alt: string;
};

type HeroSoftCta = {
  label: string;
  href: string;
  ctaId?: string;
};

type InlineOffer = {
  heading: string;
  bullets: string[];
  ctaLabel: string;
  ctaHref: string;
  trustNote?: string;
  eyebrow?: string;
};

/**
 * Shape used by both:
 * - src/data/testimonials.ts (central bank)
 * - BlogPostLayoutProps.socialProofItems
 */
type SocialProofItem = {
  quote: string;
  author: string;
  role?: string;
  avatarSrc?: string;
  rating?: number;
  class?: string;
};

/**
 * FAQ item structure:
 * - Question in plain text.
 * - Answer in sanitized HTML (pre-rendered at data/route layer).
 */
type FaqItem = {
  question: string;
  answerHtml: string;
};

/**
 * Final CTA block at bottom of article.
 */
type FinalCta = {
  heading: string;
  bodyHtml: string;
  primaryLabel: string;
  primaryHref: string;
  secondaryLabel?: string;
  secondaryHref?: string;
};

type RelatedArticle = {
  title: string;
  href: string;
  category: string;
  readingTimeMinutes?: number;
  excerpt?: string;
  dateISO?: string;
};

/**
 * ChecklistConfig is the normalized structure consumed by ChecklistSection:
 * - title/leadHtml control the framing.
 * - items is a simple ordered list of implementation steps.
 */
type ChecklistConfig = {
  title?: string;
  leadHtml?: string;
  items: string[];
};

/**
 * Slice keys:
 * - Define which bands render and in what order.
 * - Used by PRESET_SLICES and by explicit props.slices.
 */
type BlogPostLayoutSliceKey =
  | "toc"
  | "body"
  | "checklist"
  | "inlineOffer"
  | "socialProof"
  | "faq"
  | "finalCta"
  | "related";

/**
 * Article Layout Preset keys (v1.0)
 */
type BlogPostLayoutPresetKey =
  | "conversionArticle"
  | "editorialArticle"
  | "analysisArticle"
  | "shortInsight"
  | "campaignLanding";

interface BlogPostLayoutProps {
  breadcrumbs: BreadcrumbItem[];

  // Hero / meta
  category: string;
  title: string;
  heroTagline?: string;
  publishedAt?: string;
  updatedAt?: string;
  readingTimeMinutes?: number;
  authorName?: string;
  authorUrl?: string;
  heroImage?: HeroImage;
  heroSoftCta?: HeroSoftCta;

  keyTakeaways?: string[];
  introHtml?: string;

  toc?: TocItem[];
  showToc?: boolean;

  Content?: AstroComponentFactory;

  inlineOffer?: InlineOffer;
  socialProofItems?: SocialProofItem[];
  faqItems?: FaqItem[];
  finalCta?: FinalCta;
  relatedArticles?: RelatedArticle[];

  checklist?: ChecklistConfig;

  preset?: BlogPostLayoutPresetKey;
  slices?: BlogPostLayoutSliceKey[];
}

const {
  breadcrumbs,
  category,
  title,
  heroTagline,
  publishedAt,
  updatedAt,
  readingTimeMinutes,
  authorName,
  authorUrl,
  heroImage,
  heroSoftCta,
  introHtml,
  keyTakeaways = [],
  toc,
  showToc = true,
  Content,
  inlineOffer,
  socialProofItems,
  faqItems,
  finalCta,
  relatedArticles,
  checklist,
  preset,
  slices,
} = Astro.props as BlogPostLayoutProps;

/**
 * Preset → slices registry.
 */
const PRESET_SLICES: Record<BlogPostLayoutPresetKey, BlogPostLayoutSliceKey[]> = {
  conversionArticle: [
    "toc",
    "body",
    "checklist",
    "inlineOffer",
    "socialProof",
    "faq",
    "finalCta",
    "related",
  ],
  editorialArticle: ["body", "inlineOffer", "related"],
  analysisArticle: ["toc", "body", "inlineOffer", "finalCta", "related"],
  shortInsight: ["body", "related"],
  campaignLanding: ["body", "checklist", "finalCta"],
};

/**
 * Allowed presets for runtime guard (FP005-09).
 */
const ALLOWED_PRESETS: BlogPostLayoutPresetKey[] = [
  "conversionArticle",
  "editorialArticle",
  "analysisArticle",
  "shortInsight",
  "campaignLanding",
];

const hasKeyTakeaways = Array.isArray(keyTakeaways) && keyTakeaways.length > 0;
const hasToc = !!(showToc && toc && toc.length > 0);
const hasChecklist =
  !!(checklist && Array.isArray(checklist.items) && checklist.items.length > 0);
const hasInlineOffer = !!inlineOffer;
const hasSocialProof = !!(socialProofItems && socialProofItems.length > 0);
const hasFaq = !!(faqItems && faqItems.length > 0);
const hasFinalCta = !!finalCta;
const hasRelated = !!(relatedArticles && relatedArticles.length > 0);

const hasHeroImage =
  !!heroImage &&
  typeof heroImage.src === "string" &&
  heroImage.src.trim().length > 0;

/**
 * Resolve preset safely:
 * - If an explicit slices array is provided, use it.
 * - Otherwise validate preset against ALLOWED_PRESETS, else fall back.
 */
const rawPreset =
  typeof preset === "string" && preset.trim().length > 0
    ? (preset.trim() as BlogPostLayoutPresetKey | string)
    : "";

const resolvedPreset: BlogPostLayoutPresetKey =
  rawPreset && ALLOWED_PRESETS.includes(rawPreset as BlogPostLayoutPresetKey)
    ? (rawPreset as BlogPostLayoutPresetKey)
    : "conversionArticle";

const baseSlices: BlogPostLayoutSliceKey[] =
  Array.isArray(slices) && slices.length > 0
    ? slices
    : PRESET_SLICES[resolvedPreset];

/**
 * Apply data guards.
 */
const effectiveSlices: BlogPostLayoutSliceKey[] = baseSlices.filter((sliceKey) => {
  switch (sliceKey) {
    case "toc":
      return hasToc;
    case "body":
      return true;
    case "checklist":
      return hasChecklist;
    case "inlineOffer":
      return hasInlineOffer;
    case "socialProof":
      return hasSocialProof;
    case "faq":
      return hasFaq;
    case "finalCta":
      return hasFinalCta;
    case "related":
      return hasRelated;
    default:
      return false;
  }
});
---

<article class="blog-post-layout page-gap-after" data-section="blog-post">
  <header class="blog-post-layout__header">
    <div class="container">
      <div class="stack stack--first-tight">
        {breadcrumbs && breadcrumbs.length > 0 && (
          <Breadcrumbs items={breadcrumbs} />
        )}

        <ArticleHero
          category={category}
          title={title}
          heroTagline={heroTagline}
          publishedAt={publishedAt}
          updatedAt={updatedAt}
          readingTimeMinutes={readingTimeMinutes}
          authorName={authorName}
          authorUrl={authorUrl}
          softCta={heroSoftCta}
        />

        {hasHeroImage && heroImage && (
          <PostCover src={heroImage.src} alt={heroImage.alt} />
        )}

        {introHtml && <IntroBlock introHtml={introHtml} />}
      </div>
    </div>
  </header>

  {effectiveSlices.map((sliceKey) => {
    if (sliceKey === "toc") {
      if (!hasToc) return null;

      return (
        <section
          key={sliceKey}
          class="blog-post-layout__toc"
          aria-label="On this page"
        >
          <div class="container">
            <PostToc items={toc!} />
          </div>
        </section>
      );
    }

    if (sliceKey === "body") {
      return (
        <section key={sliceKey} class="blog-post-layout__body">
          <div class="container">
            <div class="blog-post-layout__body-inner">
              <div class="blog-post-layout__content prose">
                {hasKeyTakeaways && <KeyTakeaways items={keyTakeaways} />}
                {Content ? <Content /> : <slot />}
              </div>
            </div>
          </div>
        </section>
      );
    }

    if (sliceKey === "checklist") {
      if (!hasChecklist || !checklist) return null;

      return (
        <section key={sliceKey} class="blog-post-layout__checklist">
          <div class="container">
            <ChecklistSection
              title={checklist.title}
              leadHtml={checklist.leadHtml}
              items={checklist.items}
              headingLevel={2}
            />
          </div>
        </section>
      );
    }

    if (sliceKey === "inlineOffer") {
      if (!hasInlineOffer || !inlineOffer) return null;

      return (
        <section key={sliceKey} class="blog-post-layout__inline-offer">
          <div class="container">
            <InlineOfferBlock
              heading={inlineOffer.heading}
              bullets={inlineOffer.bullets}
              ctaLabel={inlineOffer.ctaLabel}
              ctaHref={inlineOffer.ctaHref}
              trustNote={inlineOffer.trustNote}
              eyebrow={inlineOffer.eyebrow}
            />
          </div>
        </section>
      );
    }

    if (sliceKey === "socialProof") {
      if (!hasSocialProof || !socialProofItems) return null;

      return (
        <section
          key={sliceKey}
          class="blog-post-layout__social-proof"
          aria-label="Customer testimonials and results"
        >
          <div class="container">
            <SocialProofStrip items={socialProofItems} />
          </div>
        </section>
      );
    }

    if (sliceKey === "faq") {
      if (!hasFaq || !faqItems) return null;

      return (
        <section
          key={sliceKey}
          class="blog-post-layout__faq"
          aria-label="Frequently asked questions"
        >
          <div class="container">
            <FAQAccordion items={faqItems} />
          </div>
        </section>
      );
    }

    if (sliceKey === "finalCta") {
      if (!hasFinalCta || !finalCta) return null;

      return (
        <section key={sliceKey} class="blog-post-layout__final-cta">
          <div class="container">
            <FinalCtaBlock
              heading={finalCta.heading}
              bodyHtml={finalCta.bodyHtml}
              primaryLabel={finalCta.primaryLabel}
              primaryHref={finalCta.primaryHref}
              secondaryLabel={finalCta.secondaryLabel}
              secondaryHref={finalCta.secondaryHref}
            />
          </div>
        </section>
      );
    }

    if (sliceKey === "related") {
      if (!hasRelated || !relatedArticles) return null;

      return (
        <section key={sliceKey} class="blog-post-layout__related">
          <div class="container">
            <RelatedArticles items={relatedArticles} />
          </div>
        </section>
      );
    }

    return null;
  })}
</article>
