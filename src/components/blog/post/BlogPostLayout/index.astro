---
/* File: src/components/blog/post/BlogPostLayout/index.astro
 * (Fix Plan 006.1 – OnePath-compliant version)
 *
 * Responsibilities:
 * - Orchestrate the full blog post experience:
 *   Hero → Intro → TOC → Body → Checklist → Inline Offer → Social Proof → FAQ → Final CTA → Related.
 * - Select slices via preset or explicit `slices`.
 * - Emit JSON-LD structured data once, at the article root.
 * - Delegate visuals to post/* components and BlogPostLayout.css.
 */

import type { AstroComponentFactory } from "astro";
import type { BlogPostPreset } from "@/lib/blog/categories";
import type { BlogPostLayoutSliceKey } from "@/lib/blog/playbooks";

import Breadcrumbs from "@/components/blog/base/Breadcrumbs";
import PostToc from "@/components/blog/compose/PostToc";
import PostCover from "@/components/blog/compose/PostCover";
import FAQAccordion from "@/components/faq/FAQAccordion";

import ArticleHero from "@/components/blog/post/ArticleHero";
import IntroBlock from "@/components/blog/post/IntroBlock";
import KeyTakeaways from "@/components/blog/post/KeyTakeaways";
import InlineOfferBlock from "@/components/blog/post/InlineOfferBlock";
import SocialProofStrip from "@/components/blog/post/SocialProofStrip";
import FinalCtaBlock from "@/components/blog/post/FinalCtaBlock";
import ChecklistSection from "@/components/blog/post/ChecklistSection";

import PostShare from "@/components/blog/base/PostShare";
import PostFeedLatest from "@/components/blog/compose/PostFeedLatest";

import "./BlogPostLayout.css";

/* -------------------------------------------------------------------------- */
/*  Types                                                                     */
/* -------------------------------------------------------------------------- */

type BreadcrumbItem = { href: string; label: string };

type TocItem = {
  id: string;
  label: string;
  level: number;
  href?: string;
};

type HeroImage = { src: string; alt: string };

type HeroSoftCta = { label: string; href: string; ctaId?: string };

type InlineOffer = {
  heading: string;
  bullets: string[];
  ctaLabel: string;
  ctaHref: string;
  trustNote?: string;
  eyebrow?: string;
};

type SocialProofItem = {
  quote: string;
  author: string;
  role?: string;
  avatarSrc?: string;
  rating?: number;
  class?: string;
};

type FaqItem = { question: string; answerHtml: string };

type FinalCta = {
  heading: string;
  bodyHtml: string;
  primaryLabel: string;
  primaryHref: string;
  secondaryLabel?: string;
  secondaryHref?: string;
};

/**
 * RelatedArticle is intentionally flexible so it can accept data both from:
 * - The route ([category]/[slug].astro) with `{ url, date: Date }`
 * - Any layout-level mapping using `{ href, dateISO }`
 */
type RelatedArticle = {
  title: string;
  href?: string;
  url?: string;
  category: string;
  readingTimeMinutes?: number;
  excerpt?: string;
  dateISO?: string;
  date?: string | Date;
};

type ChecklistConfig = {
  title?: string;
  leadHtml?: string;
  items: string[];
};

type StructuredData = Record<string, unknown>;

export interface BlogPostLayoutProps {
  breadcrumbs: BreadcrumbItem[];

  category: string;
  title: string;
  heroTagline?: string;
  publishedAt?: string;
  updatedAt?: string;
  readingTimeMinutes?: number;
  authorName?: string;
  authorUrl?: string;
  heroImage?: HeroImage;
  heroSoftCta?: HeroSoftCta;

  introHtml?: string;
  keyTakeaways?: string[];

  toc?: TocItem[];
  showToc?: boolean;

  Content?: AstroComponentFactory;

  inlineOffer?: InlineOffer;
  socialProofItems?: SocialProofItem[];
  faqItems?: FaqItem[];
  finalCta?: FinalCta;
  checklist?: ChecklistConfig;
  relatedArticles?: RelatedArticle[];

  preset?: BlogPostPreset;
  slices?: BlogPostLayoutSliceKey[];

  structuredData?: StructuredData;
}

/* -------------------------------------------------------------------------- */
/*  Preset slice registry                                                     */
/* -------------------------------------------------------------------------- */

const PRESET_SLICES: Record<BlogPostPreset, BlogPostLayoutSliceKey[]> = {
  conversionArticle: ["toc", "body", "checklist", "inlineOffer", "socialProof", "faq", "finalCta", "related"],
  editorialArticle: ["toc", "body", "socialProof", "related"],
  analysisArticle: ["toc", "body", "faq", "related"],
  shortInsight: ["body", "related"],
  campaignLanding: ["body", "inlineOffer", "faq", "finalCta", "related"],
};

/* -------------------------------------------------------------------------- */
/*  Props & derived state                                                     */
/* -------------------------------------------------------------------------- */

const {
  breadcrumbs,
  category,
  title,
  heroTagline,
  publishedAt,
  updatedAt,
  readingTimeMinutes,
  authorName,
  authorUrl,
  heroImage,
  heroSoftCta,
  introHtml,
  keyTakeaways,
  toc,
  showToc,
  Content,
  inlineOffer,
  socialProofItems,
  faqItems,
  finalCta,
  checklist,
  relatedArticles,
  preset,
  slices,
  structuredData,
} = Astro.props as BlogPostLayoutProps;

const hasHeroImage = Boolean(heroImage?.src);
const hasIntro = Boolean(introHtml);
const hasKeyTakeaways = Array.isArray(keyTakeaways) && keyTakeaways.length > 0;
const hasToc = Boolean(showToc && toc && toc.length > 0);
const hasChecklist = Boolean(checklist && checklist.items && checklist.items.length > 0);
const hasInlineOffer = Boolean(
  inlineOffer &&
    inlineOffer.heading &&
    inlineOffer.ctaLabel &&
    inlineOffer.ctaHref,
);
const hasSocialProof = Array.isArray(socialProofItems) && socialProofItems.length > 0;
const hasFaq = Array.isArray(faqItems) && faqItems.length > 0;
const hasFinalCta = Boolean(finalCta && finalCta.heading && finalCta.primaryHref);
const hasRelated = Array.isArray(relatedArticles) && relatedArticles.length > 0;

const resolvedPreset: BlogPostPreset = preset ?? "conversionArticle";
const baseSlices: BlogPostLayoutSliceKey[] =
  slices && slices.length > 0
    ? slices
    : PRESET_SLICES[resolvedPreset];

/**
 * Normalise relatedArticles into PostFeedLatest's `{ url, frontmatter }` shape.
 */
const mapRelatedToFeedPosts = (items: RelatedArticle[] | undefined) => {
  if (!items || items.length === 0) return [];

  return items.map((item) => {
    const url =
      (item.href && item.href.trim().length > 0 && item.href) ||
      (item.url && item.url.trim().length > 0 && item.url) ||
      "#";

    let date: string | Date | undefined = item.dateISO ?? item.date;

    // Ensure we always pass something parseable to PostFeedLatest.
    if (!date && item.dateISO) {
      date = item.dateISO;
    }

    return {
      url,
      frontmatter: {
        title: item.title,
        description: item.excerpt,
        date: date ?? "",
        readingTime: item.readingTimeMinutes,
        category: item.category,
      },
    };
  });
};

const effectiveSlices = baseSlices.filter((key) => {
  switch (key) {
    case "toc":
      return hasToc;
    case "body":
      return true;
    case "checklist":
      return hasChecklist;
    case "inlineOffer":
      return hasInlineOffer;
    case "socialProof":
      return hasSocialProof;
    case "faq":
      return hasFaq;
    case "finalCta":
      return hasFinalCta;
    case "related":
      return hasRelated;
    default:
      return false;
  }
});

/**
 * Ensure "related" always renders last, even if a custom `slices`
 * array places it earlier.
 */
const orderedSlices: BlogPostLayoutSliceKey[] = (() => {
  const s = [...effectiveSlices];
  const idx = s.indexOf("related");
  if (idx !== -1) {
    s.splice(idx, 1);
    s.push("related");
  }
  return s;
})();

/* -------------------------------------------------------------------------- */
/*  Structured data                                                           */
/* -------------------------------------------------------------------------- */

const structuredDataJson =
  structuredData && Object.keys(structuredData).length
    ? JSON.stringify(structuredData)
    : null;

/* -------------------------------------------------------------------------- */
/*  Share URL                                                                 */
/* -------------------------------------------------------------------------- */

/**
 * Use the current request URL for sharing.
 * - No hard-coded domain logic.
 * - Works consistently for canonical production URLs and preview/staging.
 */
const shareUrl = Astro.url?.toString();
const hasShare = Boolean(shareUrl);
---

<main id="main-content" role="main">
  <article
    class="blog-post-layout page-gap-after"
    role="article"
    aria-label={title}
    data-layout-preset={resolvedPreset}
  >
    {structuredDataJson && (
      <script type="application/ld+json">
        {structuredDataJson}
      </script>
    )}

    <!-- Hero / intro -->
    <header class="blog-post-layout__header">
      <div class="container">
        <div class="stack stack--first-tight">
          {breadcrumbs?.length > 0 && <Breadcrumbs items={breadcrumbs} />}

          <ArticleHero
            category={category}
            title={title}
            heroTagline={heroTagline}
            publishedAt={publishedAt}
            updatedAt={updatedAt}
            readingTimeMinutes={readingTimeMinutes}
            authorName={authorName}
            authorUrl={authorUrl}
            softCta={heroSoftCta}
          />

          {hasHeroImage && (
            <PostCover src={heroImage!.src} alt={heroImage!.alt} />
          )}

          {hasIntro && <IntroBlock introHtml={introHtml!} />}

          {hasShare && shareUrl && (
            <PostShare
              title={title}
              url={shareUrl}
              via="CVWriting.co.ke"
            />
          )}
        </div>
      </div>
    </header>

    <!-- Dynamic slices -->
    {orderedSlices.map((sliceKey) => {
      if (sliceKey === "toc") {
        return (
          <section
            key="toc"
            class="blog-post-layout__toc"
            role="navigation"
            aria-label="On this page"
          >
            <div class="container">
              <PostToc items={toc!} />
            </div>
          </section>
        );
      }

      if (sliceKey === "body") {
        return (
          <section
            key="body"
            class="blog-post-layout__body"
            role="region"
            aria-label="Article content"
          >
            <div class="container">
              <div class="blog-post-layout__body-inner">
                <div class="blog-post-layout__content prose">
                  {hasKeyTakeaways && <KeyTakeaways items={keyTakeaways!} />}
                  {Content ? <Content /> : <slot />}
                </div>
              </div>
            </div>
          </section>
        );
      }

      if (sliceKey === "checklist") {
        return (
          <section
            key="checklist"
            class="blog-post-layout__checklist"
            role="region"
            aria-label="Practical checklist"
          >
            <div class="container">
              <ChecklistSection config={checklist!} />
            </div>
          </section>
        );
      }

      if (sliceKey === "inlineOffer") {
        return (
          <section
            key="inlineOffer"
            class="blog-post-layout__inline-offer"
            role="region"
            aria-label="CV & LinkedIn upgrade offer"
          >
            <div class="container">
              <InlineOfferBlock offer={inlineOffer!} />
            </div>
          </section>
        );
      }

      if (sliceKey === "socialProof") {
        return (
          <section
            key="socialProof"
            class="blog-post-layout__social-proof"
            role="region"
            aria-label="Client results and testimonials"
          >
            <div class="container">
              <SocialProofStrip items={socialProofItems!} />
            </div>
          </section>
        );
      }

      if (sliceKey === "faq") {
        return (
          <section
            key="faq"
            class="blog-post-layout__faq"
            role="region"
            aria-label="Frequently asked questions"
          >
            <div class="container">
              <FAQAccordion items={faqItems!} />
            </div>
          </section>
        );
      }

      if (sliceKey === "finalCta") {
        return (
          <section
            key="finalCta"
            class="blog-post-layout__final-cta"
            role="region"
            aria-label="Next steps"
          >
            <div class="container">
              <FinalCtaBlock cta={finalCta!} />
            </div>
          </section>
        );
      }

      if (sliceKey === "related") {
        const relatedFeedPosts = mapRelatedToFeedPosts(relatedArticles);

        if (!relatedFeedPosts.length) return null;

        return (
          <section
            key="related"
            class="blog-post-layout__related"
            role="region"
            aria-label="Continue your learning"
            data-section="post-related"
          >
            <PostFeedLatest
              eyebrow="Keep learning"
              title="Continue your learning"
              posts={relatedFeedPosts}
              pageSize={4}
              moreHref={`/blog/${category}/`}
              moreLabel="View all articles in this category"
              moreAriaLabel={`View all ${category} articles`}
              clientLoadMore={false}
            />
          </section>
        );
      }

      return null;
    })}
  </article>
</main>
