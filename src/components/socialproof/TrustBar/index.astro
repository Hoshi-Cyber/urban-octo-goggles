---
// src/components/socialproof/TrustBar/index.astro

import "./TrustBar.css";

export interface Segment {
  label: string;
}

export interface Rating {
  score?: number;
  count?: number;
  label?: string;
  since?: number;
}

export interface Props {
  variant?: "default" | "compact";
  eyebrow?: string;
  rating?: Rating;
  summary?: string;
  segments?: Segment[];
  footnote?: string;
}

const props = Astro.props as Props;

const {
  variant = "default",
  eyebrow = "",
  rating,
  summary,
  segments = [],
  footnote,
} = props;

// Rating core
const score =
  typeof rating?.score === "number" && Number.isFinite(rating.score)
    ? rating.score
    : null;
const scoreText = score !== null ? score.toFixed(1) : null;

const count =
  typeof rating?.count === "number" && Number.isFinite(rating.count)
    ? rating.count
    : null;
const countText = count !== null ? count.toLocaleString() : null;

const labelTextBase =
  typeof rating?.label === "string" && rating.label.trim().length > 0
    ? rating.label.trim()
    : "reviews";
const labelText = labelTextBase;

const hasRating = score !== null;

// Copy blocks
const summaryText =
  typeof summary === "string" ? summary.trim() : "";
const hasSummary = summaryText.length > 0;

// Segments: normalize then optionally compact
const normalizedSegments = Array.isArray(segments)
  ? segments.filter(
      (segment) =>
        typeof segment?.label === "string" &&
        segment.label.trim().length > 0
    )
  : [];

const COMPACT_MAX_SEGMENTS = 5;

const displayedSegments =
  variant === "compact"
    ? normalizedSegments.slice(0, COMPACT_MAX_SEGMENTS)
    : normalizedSegments;

const remainingSegments =
  normalizedSegments.length > displayedSegments.length
    ? normalizedSegments.length - displayedSegments.length
    : 0;

const hasDisplayedSegments = displayedSegments.length > 0;

const footnoteText =
  typeof footnote === "string" ? footnote.trim() : "";
const hasFootnote = footnoteText.length > 0;

// Stars
const starCount =
  score !== null ? Math.max(1, Math.min(5, Math.round(score))) : null;
const starText = starCount ? "â˜…".repeat(starCount) : "";

// Since year
const sinceYear =
  typeof rating?.since === "number" && Number.isFinite(rating.since)
    ? rating.since
    : null;

// A11y label for rating cluster
const ratingAriaLabel = hasRating
  ? `${labelText}: ${scoreText} out of 5${
      countText ? `, based on ${countText} ${labelText}` : ""
    }${sinceYear ? `, collected since ${sinceYear}` : ""}`
  : undefined;

// Presence flags
const hasLeft = Boolean(eyebrow || hasRating);
const hasBody = hasSummary || hasDisplayedSegments || hasFootnote;
---

{hasLeft || hasBody ? (
  <section
    class={`trustbar${variant === "compact" ? " trustbar--compact" : ""}`}
    aria-label="Social proof"
  >
    <div class="trustbar__inner">
      {hasLeft && (
        <div class="trustbar__left">
          <header class="trustbar__head">
            {eyebrow && <p class="trustbar__eyebrow">{eyebrow}</p>}

            {hasRating && (
              <p class="trustbar__rating" aria-label={ratingAriaLabel}>
                {starText && (
                  <span class="trustbar__stars" aria-hidden="true">
                    {starText}
                  </span>
                )}
                <span class="trustbar__score" aria-hidden="true">
                  {scoreText}
                  <span class="trustbar__score-max">/5</span>
                </span>
                <span class="trustbar__meta" aria-hidden="true">
                  {countText ? `from ${countText}+ ${labelText}` : labelText}
                </span>
              </p>
            )}
          </header>
        </div>
      )}

      {hasBody && (
        <div class="trustbar__right">
          <div class="trustbar__body">
            {hasSummary && (
              <p class="trustbar__summary">
                {summaryText}
              </p>
            )}

            {hasDisplayedSegments && (
              <ul class="trustbar__segments" aria-label="Who this is for">
                {displayedSegments.map((segment) => (
                  <li class="trustbar__segment-chip">
                    {segment.label}
                  </li>
                ))}

                {remainingSegments > 0 && (
                  <li class="trustbar__segment-chip trustbar__segment-chip--more">
                    +{remainingSegments} more
                  </li>
                )}
              </ul>
            )}

            {hasFootnote && (
              <p class="trustbar__footnote">
                {footnoteText}
              </p>
            )}
          </div>
        </div>
      )}
    </div>
  </section>
) : null}
